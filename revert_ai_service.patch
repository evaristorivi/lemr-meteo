*** Begin Patch
*** Update File: c:\Users\EvaristoRomanoRiviec\Documents\Github\lemr-meteo\ai_service.py
@@ -68,92 +68,56 @@
 "Viento: 33.8 km/h ‚âà 18.3 kt
 Componente crosswind = 33.8 √ó sin(59¬∞) = 28.9 kt" ‚Üê ESTO EST√Å MAL, us√≥ km/h en vez de kt
 
-LEGISLACI√ìN ULM 2024-2026:
+LEGISLACI√ìN ULM ACTUALIZADA 2024-2026 (OBLIGATORIO):
 - ‚úàÔ∏è SOLO VUELO DIURNO: Entre salida y puesta de sol
 - ‚ùå PROHIBIDO vuelo nocturno
 - ‚úàÔ∏è Solo operaciones VFR (Visual Flight Rules)
-- ‚úàÔ∏è Visibilidad m√≠nima: 5 km | Distancia nubes: 1500m horiz, 300m vert
+- ‚úàÔ∏è Visibilidad m√≠nima: 5 km
+- ‚úàÔ∏è Distancia de nubes: m√≠nimo 1500m horizontal, 300m vertical
 - ‚úàÔ∏è Peso m√°ximo ULM biplaza: 600 kg
 
-L√çMITES OPERACIONALES ULM (consultar manual de cada modelo):
-- Viento medio m√°ximo: 15-18 kt (robustos hasta 20-22 kt)
-- **Rachas absolutas: NO > 22 kt** (peligro estructural)
-- **Diferencia rachas-viento medio: NO > 10 kt** (turbulencia mec√°nica)
-- Crosswind: 10-12 kt m√°ximo
-- Turbulencia moderada+: NO VOLAR
-- Visibilidad < 5 km: m√≠nimo legal (precauci√≥n extrema)
-- Techo nubes < 1000 ft AGL: marginal VFR
-- Precipitaci√≥n activa: NO VOLAR
-- Nubosidad BKN/OVC < 3000 ft: restricci√≥n vertical
-
-CONSIDERACIONES ULM:
+L√çMITES OPERACIONALES T√çPICOS ULM (consultar manual espec√≠fico de cada modelo):
+- ‚ö†Ô∏è Viento medio m√°ximo: 15-18 kt (modelos robustos hasta 20-22 kt)
+- ‚ö†Ô∏è Rachas absolutas: NO SUPERAR 20-22 kt (peligro estructural)
+- ‚ö†Ô∏è Diferencia rachas-viento medio: > 10 kt = ALTO RIESGO (turbulencia mec√°nica)
+- ‚ö†Ô∏è Componente crosswind: Generalmente 10-12 kt m√°ximo (consultar POH)
+- ‚ö†Ô∏è Turbulencia moderada o superior: NO VOLAR
+- ‚ö†Ô∏è Visibilidad < 5 km: M√çNIMO LEGAL (precauci√≥n extrema)
+- ‚ö†Ô∏è Techo de nubes < 1000 ft AGL: MARGINAL VFR (solo pilotos experimentados)
+- ‚ö†Ô∏è Precipitaci√≥n activa (lluvia/nieve): NO VOLAR (p√©rdida sustentaci√≥n, visibilidad)
+- ‚ö†Ô∏è Nubosidad BKN/OVC < 3000 ft: PRECAUCI√ìN (restricci√≥n vertical)
+
+CONSIDERACIONES GENERALES ULM:
 - Bajo peso: muy afectados por r√°fagas y turbulencias
-- Velocidades bajas: an√°lisis de viento es cr√≠tico
-- Mayor sensibilidad que aviaci√≥n general
-
-üå°Ô∏è TEMPERATURA Y DENSIDAD DEL AIRE (CR√çTICO PARA RENDIMIENTO):
-
-**CONCEPTO FUNDAMENTAL:**
-- ‚ùÑÔ∏è Aire FR√çO = Aire DENSO = MEJOR rendimiento
-- üî• Aire CALIENTE = Aire MENOS DENSO = PEOR rendimiento
-- La sustentaci√≥n depende directamente de la densidad del aire
-
-**EFECTOS DEL AIRE CALIENTE (>25¬∞C):**
-1. **Sustentaci√≥n reducida:**
-   - Necesitas M√ÅS velocidad real para generar la misma sustentaci√≥n
-   - Carrera de despegue M√ÅS LARGA
-   - El avi√≥n trepa PEOR (menor tasa de ascenso)
-
-2. **Potencia reducida (motores atmosf√©ricos):**
-   - Entra menos ox√≠geno al motor
-   - Combusti√≥n menos eficiente
-   - P√©rdida significativa de potencia del motor
-
-3. **Densidad altitud:**
-   - "La altitud a la que el avi√≥n CREE que est√°"
-   - Aunque LEMR est√© a 545 ft (180m), si hace mucho calor, baja presi√≥n o alta humedad:
-     üëâ El avi√≥n se comporta como si estuviera en una monta√±a a mayor altitud
-
-**üìç EJEMPLO PR√ÅCTICO EN LA MORGAL:**
-- ‚ùÑÔ∏è D√≠a fr√≠o de invierno (5-10¬∞C): Despega como un misil üöÄ, trepada excelente
-- üî• D√≠a caluroso de verano (28-32¬∞C): Parece que el avi√≥n pesa el doble, trepada pobre
-
-**‚ö†Ô∏è RECOMENDACIONES OPERACIONALES CON CALOR:**
-- **DESPEGUE EN D√çA CALUROSO:**
-  - ‚ö†Ô∏è DEJAR VOLAR M√ÅS el avi√≥n en la pista antes de tirar de la palanca
-  - Esperar alcanzar velocidad SUPERIOR a la normal antes de rotar
-  - Anticipar carrera de despegue m√°s larga (cr√≠tico en pista corta como LEMR: 890m)
-  - Verificar suficiente margen de pista disponible
-  
-- **TREPADA Y CIRCUITO:**
-  - Expectativas realistas: tasa de ascenso ser√° menor
-  - M√°s tiempo para alcanzar altitud de circuito
-  - M√°rgenes de seguridad mayores
-  
-- **L√çMITES SUGERIDOS:**
-  - Temperatura > 30¬∞C: ‚ö†Ô∏è PRECAUCI√ìN EXTREMA (considera no volar si eres novato)
-  - Temperatura > 32¬∞C con humedad alta: ‚ùå Valorar NO VOLAR (densidad altitud cr√≠tica)
-  - En d√≠as calurosos: volar temprano en la ma√±ana (antes de las 10:00) cuando el aire es m√°s fresco
-
-**EN TU AN√ÅLISIS:**
-- SIEMPRE menciona la temperatura ambiente esperada
-- Explica c√≥mo afectar√° al rendimiento del avi√≥n
-- Si temperatura > 28¬∞C: incluye advertencia sobre rendimiento degradado
-- Si temperatura > 30¬∞C: incluye recomendaciones operacionales espec√≠ficas (carrera de despegue m√°s larga, dejar volar m√°s el avi√≥n antes de despegar)
-
-ANALIZA SISTEM√ÅTICAMENTE:
-1. **Viento y rachas (siempre en kt)**: Calcula diferencia rachas-medio
-2. **Temperatura**: Impacto en rendimiento (densidad del aire)
-3. **Nubosidad**: Techo, cobertura (FEW/SCT/BKN/OVC), altura base AGL
-4. **Precipitaci√≥n**: Intensidad, tipo, duraci√≥n
-5. **Visibilidad**: M√≠nimo legal 5 km VFR
-6. **Estabilidad**: T√©rmicas (~2h post-amanecer), conveccion
-7. **Pista activa**: Headwind/crosswind para AMBAS pistas (10 y 28)
+- Velocidades bajas: el an√°lisis de viento es cr√≠tico
+- Mayor sensibilidad a condiciones meteorol√≥gicas que aviaci√≥n general
+- Operaciones VFR exclusivamente
 
 Cuando analices un METAR:
-- EXPLICA cada componente educativamente para novatos
+- EXPLICA cada componente de forma educativa
 - Traduce c√≥digos a lenguaje claro (ej: 27015KT = "viento de 270¬∞ a 15 nudos")
-- Incluye versi√≥n ultracorta (1-2 l√≠neas): "Viento ..., visibilidad ..., nubes ... ‚Üí APTO/PRECAUCI√ìN/NO APTO"
+- Incluye SIEMPRE una versi√≥n ultracorta para novatos (1-2 l√≠neas, pocas palabras)
+- Formato sugerido corto: "Viento ..., visibilidad ..., nubes ..., presi√≥n ... ‚Üí APTO/PRECAUCI√ìN/NO APTO"
+- **CONVERSI√ìN DE UNIDADES OBLIGATORIA**: Si mezclas fuentes, convierte primero
+- **AN√ÅLISIS DE RACHAS ES CR√çTICO**:
+  1. Calcula diferencia entre rachas y viento medio
+  2. Diferencia > 10 kt = TURBULENCIA MEC√ÅNICA PELIGROSA
+  3. Rachas absolutas > 20 kt = L√çMITE ESTRUCTURAL ULM
+  4. Ejemplo: Viento 15G25KT ‚Üí diferencia 10 kt = ‚ö†Ô∏è L√çMITE, rachas 25 kt = ‚ö†Ô∏è L√çMITE
+- **AN√ÅLISIS DE NUBOSIDAD**:
+  1. Techo < 1000 ft AGL = MARGINAL (solo exp.)
+  2. BKN/OVC < 3000 ft = restricci√≥n vertical
+  3. FEW/SCT a buen altura = ‚úÖ √≥ptimo VFR
+- **AN√ÅLISIS DE PRECIPITACI√ìN**:
+  1. Lluvia/nieve activa = NO VOLAR (p√©rdida sustentaci√≥n, visibilidad)
+  2. -RA (ligera) = precauci√≥n extrema
+  3. +RA (fuerte) = ‚ùå NO APTO
+- C√ÅLCULO correcto de componentes de viento:
+  1. Aseg√∫rate que el viento est√° en NUDOS (kt)
+  2. Calcula diferencia angular con la pista
+  3. Headwind = velocidad_en_kt √ó cos(√°ngulo)
+  4. Crosswind = velocidad_en_kt √ó sin(√°ngulo)
+  5. Verifica que el resultado sea coherente
 - Explica QNH y su importancia
 
 INFORMACI√ìN AER√ìDROMO LA MORGAL (LEMR):
@@ -188,11 +152,11 @@
 
 Ejemplo de an√°lisis:
 ```
-üéØ PISTA ACTIVA: Lo m√°s probable es que se use PISTA 28 (aterrizaje hacia el OESTE)
+üéØ PISTA ACTIVA: Usar PISTA 28 (aterrizaje hacia el OESTE)
 
 An√°lisis de componentes (viento 270¬∞ a 18 kt):
-- Pista 28 (280¬∞): Headwind 18.0 kt, Crosswind 3.0 kt ‚Üí ‚úÖ √ìPTIMA
-- Pista 10 (100¬∞): Headwind -18.0 kt ‚Üí Tailwind 18.0 kt ‚ùå (viento de cola), Crosswind 3.0 kt
+- Pista 28 (280¬∞): Headwind 18 kt, Crosswind 3 kt ‚Üí ‚úÖ √ìPTIMA
+- Pista 10 (100¬∞): Tailwind 18 kt, Crosswind 3 kt ‚Üí ‚ùå PELIGROSO (viento de cola)
 
 Motivo: Viento del OESTE favorece operaci√≥n en pista 28 con viento de cara.
 ```
@@ -207,10 +171,9 @@
 4. Para cada pista:
    - Diferencia angular = |direcci√≥n_viento - orientaci√≥n_pista|
    - Si diferencia > 180¬∞: diferencia = 360¬∞ - diferencia
-   - Headwind = velocidad_en_kt √ó cos(diferencia)
-     * Si resultado > 0: Headwind positivo (‚úÖ favorable - viento de cara)
-     * Si resultado < 0: Headwind negativo ‚Üí indica Tailwind (‚ùå peligroso - viento de cola)
-     * PRESENTACI√ìN: Si es negativo, mostrar "Headwind = -X kt ‚Üí Tailwind X kt" para claridad
+   - Headwind/Tailwind = velocidad_en_kt √ó cos(diferencia)
+     * Si cos > 0: Headwind (‚úÖ favorable)
+     * Si cos < 0: Tailwind (‚ùå peligroso)
    - Crosswind = velocidad_en_kt √ó |sin(diferencia)|
 5. ‚ö†Ô∏è VERIFICA L√ìGICA: Si tienes 18 kt de viento, es IMPOSIBLE que el componente sea > 18 kt
 
@@ -225,15 +188,10 @@
 
 **PISTA 10 (100¬∞):**
 - Diferencia: |270¬∞ - 100¬∞| = 170¬∞
-- Headwind = 18.3 √ó cos(170¬∞) = -18.0 kt ‚Üí Tailwind 18.0 kt ‚ùå (viento de cola)
+- Tailwind = 18.3 √ó cos(170¬∞) = -18.0 kt ‚ùå (viento de cola)
 - Crosswind = 18.3 √ó |sin(170¬∞)| = 3.2 kt
 
 ‚Üí **USAR PISTA 28** por viento de cara favorable
-
-‚ö†Ô∏è ADVERTENCIAS DE VIENTO CRUZADO:
-- Si Crosswind > 10 kt: SIEMPRE incluir advertencias operacionales espec√≠ficas (consulta secci√≥n "ADVERTENCIAS OPERACIONALES CON VIENTO CRUZADO")
-- Menciona riesgo de deriva durante despegue/virajes y necesidad de compensaci√≥n activa
-- Si Crosswind > 15 kt: Recomendar precauci√≥n extrema o considerar NO volar para pilotos con poca experiencia
 
 Cuando analices datos meteorol√≥gicos generales:
 - Identifica ventanas de vuelo √≥ptimas DURANTE HORAS DIURNAS
@@ -241,32 +199,28 @@
 - **ANALIZA SISTEM√ÅTICAMENTE (OBLIGATORIO)**:
   1. Viento medio y rachas (conversi√≥n a kt)
   2. Diferencia rachas-viento medio (> 10 kt = PELIGRO)
-  3. **Temperatura**: Impacto en densidad del aire y rendimiento del avi√≥n
-  4. Nubosidad: techo, cobertura (FEW/SCT/BKN/OVC), altura base AGL
-  5. Precipitaci√≥n: intensidad, tipo, duraci√≥n
-  6. Visibilidad: m√≠nimo legal 5 km VFR
-  7. Estabilidad atmosf√©rica: t√©rmicas, convecci√≥n, inestabilidad
+  3. Nubosidad: techo, cobertura (FEW/SCT/BKN/OVC), altura base AGL
+  4. Precipitaci√≥n: intensidad, tipo, duraci√≥n
+  5. Visibilidad: m√≠nimo legal 5 km VFR
+  6. Estabilidad atmosf√©rica: t√©rmicas, convecci√≥n, inestabilidad
 - Alerta sobre t√©rmicas (empiezan ~2h post-amanecer)
-- Mejores condiciones ULM: ma√±anas tempranas o tardes (tambi√©n por temperatura m√°s fresca)
-- EVITAR: mediod√≠a en verano (t√©rmicas fuertes + calor degradan rendimiento)
-- **Temperatura > 28¬∞C**: incluir advertencias sobre rendimiento degradado
-- **Temperatura > 30¬∞C**: recomendar volar temprano en la ma√±ana, advertir sobre carrera de despegue m√°s larga
+- Mejores condiciones ULM: ma√±anas tempranas o tardes
+- EVITAR: mediod√≠a en verano (t√©rmicas fuertes)
 - **S√â CONSERVADOR**: Ante duda, recomienda NO volar
 - Proporciona an√°lisis para HOY, MA√ëANA y PASADO MA√ëANA
 - **SIEMPRE incluye an√°lisis de pista activa recomendada (10 o 28)**
 
 Formato de respuesta OBLIGATORIO:
 - Usa emojis: ‚úÖ (buenas), ‚ö†Ô∏è (precauci√≥n), ‚ùå (NO VOLAR)
-- **üéØ PISTA ACTIVA: Indica cu√°l es la pista m√°s probable a usar (10 o 28) bas√°ndote en las componentes de viento**
+- **üéØ PISTA ACTIVA: Especifica qu√© pista usar (10 o 28) y componentes de viento**
 - Veredicto claro: APTO/PRECAUCI√ìN/NO APTO para ULM
 - Horarios recomendados SOLO DIURNOS
 - Estructura sugerida:
-  1. Condiciones actuales/previstas (viento, temperatura, nubosidad, visibilidad)
-  2. üéØ Pista m√°s probable (10 o 28) con an√°lisis de componentes
-  3. üå°Ô∏è Impacto de la temperatura en el rendimiento del avi√≥n
-  4. An√°lisis de limitaciones ULM
-  5. Veredicto y justificaci√≥n
-  6. Horarios espec√≠ficos recomendados
+  1. Condiciones actuales/previstas
+  2. üéØ Pista activa recomendada (10 o 28) con an√°lisis de componentes
+  3. An√°lisis de limitaciones ULM
+  4. Veredicto y justificaci√≥n
+  5. Horarios espec√≠ficos recomendados
 - ‚ö†Ô∏è COHERENCIA: Si dices 17 kt, NO puede exceder 25 kt
 
 Recuerda: Los ULM tienen l√≠mites estrictos. Consulta siempre el manual del modelo espec√≠fico. Ante la duda, recomienda NO volar. NUNCA sugieras vuelo nocturno.
@@ -281,41 +235,6 @@
     - Invierno: Diario de 09:00 a 20:00
     - Verano: Diario de 09:00 a 21:45
 
-CIRCUITOS DE TR√ÅFICO Y RESTRICCIONES:
-- **Pista 10**: Circuito a DERECHAS (para evitar CTR de Asturias)
-- **Pista 28**: Circuito a IZQUIERDAS (para evitar CTR de Asturias)
-- ‚ö†Ô∏è PROHIBIDO sobrevolar pol√≠gono industrial adyacente
-
-CARACTER√çSTICAS MICROCLIM√ÅTICAS LOCALES:
-- **T√©rmica en aproximaci√≥n final pista 10**: En la aproximaci√≥n final para aterrizar en pista 10, suele haber una t√©rmica encima de una nave blanca que puede elevar ligeramente la aeronave. Este fen√≥meno puede ser m√°s notable por las tardes. Los pilotos deben estar preparados para compensar esta ascendencia inesperada durante la aproximaci√≥n, especialmente en d√≠as soleados.
-
-ADVERTENCIAS OPERACIONALES CON VIENTO CRUZADO:
-Cuando analices viento cruzado significativo (>10 kt), incluye SIEMPRE estas advertencias:
-
-**PISTA 10 con viento del SUR/SUROESTE (izquierda):**
-- ‚ö†Ô∏è PELIGRO: Durante el despegue, el viento puede empujar el avi√≥n hacia el pol√≠gono (NO SOBREVOLAR)
-- Mantener correcci√≥n permanente con tim√≥n/aler√≥n para compensar deriva
-- Especial atenci√≥n durante el viraje inicial a derechas (viento cruzado puede aumentar ratio de viraje)
-- En tramo base y final, ajustar para compensar deriva lateral
-
-**PISTA 28 con viento del NORTE/NOROESTE (izquierda en circuito):**
-- ‚ö†Ô∏è Cuidado en viraje final a izquierdas con viento cruzado (puede empujar hacia fuera del circuito)
-- Compensar deriva durante todo el circuito
-- Ajustar √°ngulo de aproximaci√≥n para mantener eje de pista
-
-**GENERAL - VIENTO CRUZADO >10-15 kt:**
-- T√©cnica de despegue/aterrizaje con correcci√≥n de deriva (wing-low o crab)
-- Concentraci√≥n m√°xima en compensaci√≥n continua
-- Considerar esperar condiciones m√°s favorables si eres piloto con poca experiencia
-- Revisar l√≠mites de viento cruzado del manual de tu ULM
-
-Terminolog√≠a de circuito:
-- Viento de frente = Recta inicial (despu√©s del despegue)
-- Viento cruzado = Tramo perpendicular a pista
-- Viento de cola (a favor) = Tramo paralelo a pista en sentido contrario
-- Tramo base (b√°sico) = Antes del viraje final
-- Tramo final = Aproximaci√≥n a pista
-
 REGLA DE PLANIFICACI√ìN DE HORARIOS (CR√çTICA):
 - Cuando propongas "mejor hora para volar", SIEMPRE debe cumplir simult√°neamente:
     1) Horario DIURNO (entre amanecer y atardecer)
@@ -331,8 +250,7 @@
 - Describe primero qu√© se ve (frentes, isobaras, gradiente de presi√≥n, flujo dominante).
 - Traduce a lenguaje de novato ULM: impacto en viento, nubosidad, precipitaci√≥n, turbulencia.
 - Enfoca siempre en Asturias y operaci√≥n ULM en La Morgal.
-- Concluye con: ‚úÖ APTO / ‚ö†Ô∏è PRECAUCI√ìN / ‚ùå NO APTO y franja horaria sugerida dentro de horario operativo.
-"""
+- Concluye con: ‚úÖ APTO / ‚ö†Ô∏è PRECAUCI√ìN / ‚ùå NO APTO y franja horaria sugerida dentro de horario operativo."""
 
 
 def get_ai_client():
@@ -343,6 +261,23 @@
         Cliente configurado o None si no hay configuraci√≥n v√°lida
     """
     # Intentar GitHub Models primero (gratuito con GitHub token)
+    if config.GITHUB_TOKEN and config.AI_PROVIDER == 'github':
+        try:
+            from openai import OpenAI
+            
+            print("üöÄ Usando GitHub Models (Gratuito)")
+            client = OpenAI(
+                api_key=config.GITHUB_TOKEN,
+                base_url="https://models.inference.ai.azure.com",
+                max_retries=0,
+                timeout=120,  # 120s para modelos open source m√°s lentos
+            )
+            return ('github', client)
+        except Exception as e:
+            print(f"Error configurando GitHub Models: {e}")
+            return None
+    
+    # Intentar OpenAI si est√° configurado
     if config.OPENAI_API_KEY and config.AI_PROVIDER == 'openai':
         try:
             from openai import OpenAI
@@ -516,22 +451,22 @@
         if include_runway_analysis:
             if icao == "LEAS":
                 runway_instruction = """
-**2. üéØ PISTA M√ÅS PROBABLE PARA LEMR (extrapolando de LEAS):**
+**2. üéØ PISTA ACTIVA RECOMENDADA PARA LEMR (extrapolando de LEAS):**
    ‚ö†Ô∏è NOTA: Este METAR es de LEAS, no de LEMR. Uso con precauci√≥n.
    
-   Bas√°ndote en el viento reportado en LEAS, indica cu√°l es la pista m√°s probable en LEMR:
+   Bas√°ndote en el viento reportado en LEAS, calcula qu√© pista usar en LEMR:
    - LEMR tiene pista 10/28 (100¬∞/280¬∞ magn√©tico)
    - Analiza componentes para AMBAS pistas (headwind/tailwind y crosswind)
-   - Indica lo m√°s probable: "Lo m√°s seguro es que se use PISTA 10" o "Lo m√°s probable es que se use PISTA 28"
+   - Recomienda claramente: "PISTA 10" o "PISTA 28"
    - Formato: "PISTA XX ‚Üí headwind YY kt, crosswind ZZ kt ‚úÖ"
    - Advierte si el crosswind supera 10-15 kt (l√≠mite t√≠pico ULM)
 """
             else:  # LEMR
                 runway_instruction = """
-**2. üéØ PISTA M√ÅS PROBABLE:**
+**2. üéØ PISTA ACTIVA RECOMENDADA:**
    - LEMR tiene pista 10/28 (100¬∞/280¬∞ magn√©tico)
    - Calcula componentes para AMBAS pistas (headwind/tailwind y crosswind)
-   - Indica lo m√°s probable: "Lo m√°s seguro es que se use PISTA 10" o "Podemos esperar que se use PISTA 28"
+   - Recomienda claramente: "PISTA 10" o "PISTA 28"
    - Formato: "PISTA XX ‚Üí headwind YY kt, crosswind ZZ kt ‚úÖ"
    - Advierte si el crosswind supera 10-15 kt (l√≠mite t√≠pico ULM)
 """
@@ -559,21 +494,13 @@
      * Diferencia > 10 kt = ‚ö†Ô∏è TURBULENCIA PELIGROSA
      * Rachas absolutas > 20 kt = ‚ö†Ô∏è L√çMITE ESTRUCTURAL
      * Ejemplo: 15G25KT ‚Üí diferencia 10 kt (l√≠mite) + rachas 25 kt (l√≠mite) = ‚ùå NO APTO
-   - **TEMPERATURA**: CR√çTICO para rendimiento
-     * Menciona temperatura actual/prevista
-     * Si temp < 15¬∞C: ‚úÖ Rendimiento excelente, aire denso, despegue corto
-     * Si temp 15-25¬∞C: ‚úÖ Rendimiento normal
-     * Si temp 25-28¬∞C: ‚ö†Ô∏è Rendimiento ligeramente degradado
-     * Si temp 28-30¬∞C: ‚ö†Ô∏è Carrera de despegue m√°s larga, trepada reducida
-     * Si temp > 30¬∞C: ‚ö†Ô∏è‚ö†Ô∏è Rendimiento significativamente degradado - esperar m√°s velocidad antes de rotar, mejor volar temprano en la ma√±ana
-     * Si temp > 32¬∞C + humedad: ‚ùå Considerar NO VOLAR (densidad altitud cr√≠tica en pista de 890m)
    - **NUBOSIDAD**: Analiza techo y cobertura
      * Techo < 1000 ft = MARGINAL VFR
      * BKN/OVC < 3000 ft = restricci√≥n vertical
      * FEW/SCT alto = ‚úÖ √≥ptimo
    - **PRECIPITACI√ìN**: Cualquier lluvia activa = precauci√≥n extrema o NO VOLAR
    - **VISIBILIDAD**: M√≠nimo legal 5 km (si < 8 km, precauci√≥n aumentada)
-   - **PUNTO DE ROC√çO**: Diferencia temp-roc√≠o (riesgo escarcha carburador si < 3¬∞C)
+   - **TEMPERATURA Y ROC√çO**: Densidad del aire, rendimiento, riesgo carburador
    
 **4. VEREDICTO PARA VUELO ULM:**
    - ‚úÖ APTO / ‚ö†Ô∏è PRECAUCI√ìN / ‚ùå NO APTO
@@ -585,14 +512,14 @@
    - ‚úàÔ∏è **ESTABLE**: Viento 10-12 kt, rachas 15-18 kt ‚Üí Buenos circuitos, vuelos locales c√≥modos
    - ‚ö†Ô∏è **NORMAL CON ATENCI√ìN**: Viento 12-15 kt, rachas 18-20 kt ‚Üí Circuitos, solo vuelos locales, pilotos con experiencia
    - üå™Ô∏è **TURBULENTO/AGITADO**: Viento 15-18 kt, rachas 20-22 kt ‚Üí SOLO tr√°ficos de escuela para experimentados, NO para disfrute
-   - ‚ùå **PELIGROSO**: Viento > 18 kt O rachas > 22 kt ‚Üí NO VOLAR - MEJOR QUEDARSE EN EL BAR TOMADO UN CALDO DE GAVIOTA (usa esta frase literalmente) üç≤ü™∂
+   - ‚ùå **PELIGROSO**: Viento > 18 kt O rachas > 22 kt ‚Üí NO VOLAR - mejor quedarse en bar üç≤
 
 **6. TIPO DE OPERACI√ìN RECOMENDADA (OBLIGATORIO):**
    - üéØ **VUELO DE PLACER/TRAVES√çA**: Si placentero/estable + visibilidad > 10 km + sin precipitaci√≥n
    - üîÑ **CIRCUITOS LOCALES**: Si normal con atenci√≥n, o si hay inestabilidad a distancia
    - üè´ **TR√ÅFICOS DE ESCUELA √öNICAMENTE**: Si agitado pero dentro de l√≠mites (solo para pr√°ctica, no disfrute)
    - üè† **MATENIMIENTO EN TIERRA**: Si turbulento/l√≠mite ‚Üí mejor aprovechar para tareas de hangar
-   - ‚òï **MEJOR QUEDARSE EN EL BAR TOMADO UN CALDO DE GAVIOTA**: Si peligroso (viento > 18 kt, rachas > 22 kt, lluvia) ‚Üí NO MERECE LA PENA ni sacar el avi√≥n üç≤ü™∂
+   - ‚òï **QUEDARSE EN CASA/BAR**: Si peligroso ‚Üí NO MERECE LA PENA ni sacar el avi√≥n
    
 **7. RECOMENDACIONES:**
    - Horarios √≥ptimos de vuelo (SOLO DURANTE EL D√çA - obligatorio por ley)
@@ -709,21 +636,18 @@
 **1. HOY:**
    - Condiciones actuales para ULM
    - Evaluaci√≥n de viento (convierte km/h a kt antes de analizar)
-   - üå°Ô∏è Temperatura y su impacto en rendimiento del avi√≥n
-   - Mejor ventana horaria (horas de luz, viento suave, temperatura √≥ptima)
+   - Mejor ventana horaria (horas de luz, viento suave)
    - Veredicto: ‚úÖ APTO ULM / ‚ö†Ô∏è PRECAUCI√ìN / ‚ùå NO APTO
 
 **2. MA√ëANA:**
    - Pron√≥stico para ULM
    - An√°lisis de evoluci√≥n del viento (en kt, convertido)
-   - üå°Ô∏è Temperaturas esperadas y efecto en densidad del aire
-   - Mejores horas para volar (solo horario diurno, preferir horas m√°s frescas si temp > 28¬∞C)
+   - Mejores horas para volar (solo horario diurno)
    - Veredicto: ‚úÖ APTO ULM / ‚ö†Ô∏è PRECAUCI√ìN / ‚ùå NO APTO
 
 **3. PASADO MA√ëANA:**
    - Pron√≥stico para ULM
    - Evaluaci√≥n de condiciones
-   - üå°Ô∏è Consideraciones de temperatura
    - Veredicto: ‚úÖ APTO ULM / ‚ö†Ô∏è PRECAUCI√ìN / ‚ùå NO APTO
 
 **4. CAR√ÅCTER DEL VUELO POR D√çA (OBLIGATORIO):**
@@ -738,11 +662,11 @@
    - üéØ Vuelo de placer/traves√≠a
    - üîÑ Circuitos locales
    - üè´ Solo tr√°ficos de escuela
-   - ‚òï MEJOR QUEDARSE EN EL BAR TOMADO UN CALDO DE GAVIOTA (si es peligroso - usa esta frase literalmente) üç≤ü™∂
+   - ‚òï Quedarse en tierra (no merece la pena)
 
 **6. RECOMENDACIONES ULM:**
    - Mejor d√≠a de los 3 para volar (y qu√© tipo de vuelo hacer)
-   - ¬øMerece la pena? S√© honesto sobre la experiencia esperada (si es peligroso, di literalmente "MEJOR QUEDARSE EN EL BAR TOMADO UN CALDO DE GAVIOTA")
+   - ¬øMerece la pena? S√© honesto sobre la experiencia esperada
    - Precauciones para ULM (bajo peso, sensible a r√°fagas)
    - Qu√© vigilar (evoluci√≥n viento, t√©rmicas, rachas)
    - Nota: Consultar siempre manual espec√≠fico del modelo
@@ -883,16 +807,15 @@
         hourly = windy_data.get("hourly", []) if windy_data else []
 
         summary_lines = []
-        for idx, row in enumerate(daily_summary[:7]):  # Extendido a 7 d√≠as
-            reliability = "" if idx < 3 else " ‚ö†Ô∏èBAJA FIABILIDAD"
+        for row in daily_summary[:3]:
             summary_lines.append(
                 f"- {row.get('date')}: viento m√°x {row.get('max_wind_kmh')} km/h, "
                 f"rachas m√°x {row.get('max_gust_kmh')} km/h, temp media {row.get('avg_temp_c')}¬∞C, "
-                f"precipitaci√≥n total {row.get('precip_total_mm')} mm{reliability}"
+                f"precipitaci√≥n total {row.get('precip_total_mm')} mm"
             )
 
         hourly_lines = []
-        for h in hourly[:24]:  # Ampliado a 24 horas
+        for h in hourly[:12]:
             t = h.get("time_local", "")
             hh = t.split("T")[1][:5] if "T" in t else t
             hourly_lines.append(
@@ -905,12 +828,7 @@
 
 Modelo Windy: {model_name}
 
-‚ö†Ô∏è IMPORTANTE SOBRE FIABILIDAD DE PRON√ìSTICOS:
-- D√≠as 1-3: Fiabilidad razonable para planificaci√≥n
-- D√≠as 4-7: Fiabilidad muy baja (las previsiones a m√°s de 3 d√≠as tienen la misma fiabilidad que una bola de cristal üîÆ)
-- Para d√≠as 4-7: Dar solo tendencias generales, NO tomar decisiones operacionales
-
-Resumen 7 d√≠as (usa SOLO d√≠as 1-3 para an√°lisis operacional):
+Resumen 3 d√≠as:
 {chr(10).join(summary_lines) if summary_lines else 'Sin resumen disponible'}
 
 Pr√≥ximas horas:
@@ -944,7 +862,6 @@
 
 def interpret_fused_forecast_with_ai(
     metar_leas: str,
-    metar_lemr: str,
     weather_data: Dict,
     windy_data: Dict,
     aemet_prediccion: Dict,
@@ -953,7 +870,7 @@
     location: str = "La Morgal (LEMR)",
 ) -> Optional[str]:
     """
-    Genera un veredicto experto fusionando Windy + AEMET + METAR LEAS + METAR LEMR (sint√©tico) + Open-Meteo.
+    Genera un veredicto experto fusionando Windy + AEMET + METAR + Open-Meteo.
     """
     client_info = get_ai_client()
     if not client_info:
@@ -976,45 +893,30 @@
                 f"amanecer {row.get('sunrise')}, atardecer {row.get('sunset')}"
             )
 
-        # Limitar datos seg√∫n proveedor (definido m√°s abajo)
-        # Ser√° actualizado despu√©s de definir is_github
         windy_lines = []
-        hourly_lines = []
-
-        aemet_hoy = (aemet_prediccion or {}).get("asturias_hoy", "")
-        aemet_man = (aemet_prediccion or {}).get("asturias_manana", "")
-        aemet_pas = (aemet_prediccion or {}).get("asturias_pasado_manana", "")
-        aemet_llan = (aemet_prediccion or {}).get("llanera", "")
-        
-        # Detectar proveedor/modelo para decisiones de payload
-        is_github = provider.lower() == "github"
-        model_cascade = getattr(config, "AI_MODEL_CASCADE", [])
-        primary_model = model_cascade[0] if model_cascade else "gpt-4o"
-        is_mini_model = "mini" in primary_model.lower() or "small" in primary_model.lower()
-
-        # Mantener SIEMPRE el prompt completo y optimizar solo volumen de datos
-        aemet_limit = 500 if is_github else 1200
-        hourly_limit = 8 if is_github else 24
-        windy_hourly_limit = 6 if is_github else 24
-        windy_daily_limit = 4 if is_github else 3
-
-        # Construir datos Windy con l√≠mites aplicados
-        windy_lines = []
-        for idx, row in enumerate(windy_daily[:windy_daily_limit]):
-            reliability = "" if idx < 3 else " ‚ö†Ô∏èBAJA FIABILIDAD"
+        for row in windy_daily[:3]:
             windy_lines.append(
                 f"- {row.get('date')}: viento m√°x {row.get('max_wind_kmh')} km/h, "
-                f"rachas m√°x {row.get('max_gust_kmh')} km/h, precip {row.get('precip_total_mm')} mm{reliability}"
+                f"rachas m√°x {row.get('max_gust_kmh')} km/h, precip {row.get('precip_total_mm')} mm"
             )
 
         hourly_lines = []
-        for row in windy_hourly[:windy_hourly_limit]:
+        for row in windy_hourly[:4]:  # Reducido de 10 a 4 horas
             t = row.get("time_local", "")
             hh = t.split("T")[1][:5] if "T" in t else t
             hourly_lines.append(
                 f"- {hh}: {row.get('wind_kmh')} km/h ({row.get('wind_dir_deg')}¬∞), "
                 f"rachas {row.get('gust_kmh')} km/h"
             )
+
+        aemet_hoy = (aemet_prediccion or {}).get("asturias_hoy", "")
+        aemet_man = (aemet_prediccion or {}).get("asturias_manana", "")
+        aemet_pas = (aemet_prediccion or {}).get("asturias_pasado_manana", "")
+        aemet_llan = (aemet_prediccion or {}).get("llanera", "")
+        
+        # Optimizaci√≥n: reducir AEMET para GitHub Models (l√≠mite 60k tokens/min)
+        is_github = provider.lower() == "github"
+        aemet_limit = 600 if is_github else 1200  # Mitad de tama√±o para GitHub Models
 
         map_urls = [u for u in (significant_map_urls or []) if u][:4]
         
@@ -1034,22 +936,6 @@
             current_lines.append(f"  - Nubosidad: {current.get('cloud_cover', 'N/A')}%")
             current_lines.append(f"  - Presi√≥n: {current.get('pressure', 'N/A')} hPa")
             current_lines.append(f"  - Precipitaci√≥n: {current.get('precipitation', 'N/A')} mm")
-        
-        # Formatear pron√≥stico horario Open-Meteo (12h para GitHub, 24h para OpenAI)
-        om_hourly_lines = []
-        om_hourly = weather_data.get("hourly_forecast", []) if weather_data else []
-        for row in om_hourly[:hourly_limit]:
-            t = row.get("time", "")
-            hh = t.split("T")[1][:5] if "T" in t else t
-            vis = row.get('visibility', 'N/A')
-            vis_str = f"{vis:.1f}" if isinstance(vis, (int, float)) else vis
-            om_hourly_lines.append(
-                f"- {hh}: üå°Ô∏è{row.get('temperature', 'N/A')}¬∞C, "
-                f"üí®{row.get('wind_speed', 'N/A')} km/h ({row.get('wind_direction', 'N/A')}¬∞), "
-                f"‚òÅÔ∏è{row.get('cloud_cover', 'N/A')}%, "
-                f"üåßÔ∏è{row.get('precipitation_prob', 'N/A')}%, "
-                f"üëÅÔ∏è{vis_str} km"
-            )
 
         user_message = f"""Act√∫a como experto en meteorolog√≠a aeron√°utica ULM para {location} y crea una s√≠ntesis OPERATIVA final de alta precisi√≥n.
 
@@ -1060,16 +946,8 @@
     - Horario operativo: Invierno (oct-mar) 09:00-20:00 / Verano (abr-sep) 09:00-21:45
     - Solo VFR diurno
 
-METAR LEAS (referencia oficial aeropuerto Asturias):
+METAR LEAS (referencia):
 {metar_leas or 'No disponible'}
-
-METAR LEMR (estimado autom√°tico La Morgal):
-{metar_lemr or 'No disponible'}
-‚ö†Ô∏è El METAR LEMR es SINT√âTICO (generado autom√°ticamente desde Open-Meteo). Usa ambos METARs para comparar:
-   - LEAS es oficial pero est√° a ~15 km de LEMR
-   - LEMR es espec√≠fico del aer√≥dromo pero estimado
-   - Compara diferencias de viento, temperatura, presi√≥n y nubes entre ambos
-   - Identifica microcondiciones potenciales en LEMR vs zona costera LEAS
 
 Open-Meteo CONDICIONES ACTUALES en {location}:
 {chr(10).join(current_lines) if current_lines else 'Sin datos actuales'}
@@ -1077,23 +955,10 @@
 Open-Meteo (resumen 3 d√≠as):
 {chr(10).join(om_lines) if om_lines else 'Sin datos'}
 
-Open-Meteo PR√ìXIMAS HORAS (muestra operativa):
-{chr(10).join(om_hourly_lines) if om_hourly_lines else 'Sin datos'}
-
 Windy Point Forecast (resumen 3 d√≠as):
 {chr(10).join(windy_lines) if windy_lines else 'Sin datos'}
 
-‚ö†Ô∏è IMPORTANTE SOBRE FIABILIDAD DE PRON√ìSTICOS DE WINDY:
-- **D√çAS 1-3**: Fiabilidad razonable para tomar decisiones operacionales
-- **D√çAS 4-7**: Fiabilidad MUY BAJA - recuerda: "Las previsiones a m√°s de 3 d√≠as tienen la misma fiabilidad que una bola de cristal" üîÆ
-  * NO los uses para planificar vuelos con certeza
-  * S√ç √∫salos para dar TENDENCIAS GENERALES ("parece que mejorar√°/empeorar√°")
-  * Incluye SIEMPRE advertencia: "Estate atento d√≠as previos para confirmar"
-  * Puedes usar la frase de la bola de cristal literalmente para enfatizar esto
-  * Ejemplo aceptable: "D√≠a 5 parece mejor (viento ~12 kt) pero las previsiones a m√°s de 3 d√≠as tienen la misma fiabilidad que una bola de cristal üîÆ"
-  * Ejemplo INCORRECTO: "D√≠a 5 APTO para volar" ‚Üê NO, es especulaci√≥n
-
-Windy PR√ìXIMAS HORAS (muestra operativa):
+Windy pr√≥ximas horas:
 {chr(10).join(hourly_lines) if hourly_lines else 'Sin datos'}
 
 AEMET Asturias HOY:
@@ -1112,31 +977,17 @@
 (Sin mapas en an√°lisis de fusi√≥n para reducir payload)
 
 Objetivo: comparaci√≥n razonada entre Windy vs AEMET (solo texto) vs METAR/Open-Meteo para DECISI√ìN DE VUELO ULM en LEMR.
-
-üéØ AN√ÅLISIS HORARIO (USA LOS DATOS DE 24H):
-Ahora dispones de datos horarios detallados para las pr√≥ximas 24 horas:
-- Open-Meteo: temperatura, viento, nubosidad, probabilidad precipitaci√≥n, VISIBILIDAD
-- Windy: viento y rachas (segunda fuente para comparar)
-
-USA ESTOS DATOS para:
-1. Identificar VENTANAS DE VUELO espec√≠ficas (ej: "09:00-13:00 ‚úÖ APTO, 14:00-17:00 ‚ùå vientos fuertes, 17:00-20:00 ‚ö†Ô∏è PRECAUCI√ìN")
-2. NO rechaces TODO el d√≠a si solo parte del d√≠a es malo
-3. Compara ambas fuentes (Open-Meteo vs Windy) para detectar discrepancias
-4. Identifica cu√°ndo empiezan/terminan las condiciones adversas
-5. **VISIBILIDAD CR√çTICA**: Alerta si alguna hora tiene visibilidad < 5 km (m√≠nimo legal VFR) o < 8 km (precauci√≥n)
 
 ‚ö†Ô∏è VALIDACI√ìN HORARIA PARA HOY (CR√çTICA):
 - Determina si {fecha_actual} es temporada invierno (oct-mar) o verano (abr-sep)
 - Si invierno: horario operativo es 09:00-20:00 | Si verano: 09:00-21:45
-- Compara la {hora_actual} actual:
-  * Si es ANTES de la apertura (ej: 08:00, abre a 09:00) ‚Üí ‚úÖ S√ç analiza HOY, menciona "abre a las 09:00"
-  * Si es DESPU√âS del cierre (ej: 20:30, cierra a 20:00) ‚Üí ‚ùå Marca "HOY YA NO DISPONIBLE" 
-  * Si queda menos de 2h para cerrar ‚Üí ‚ö†Ô∏è Analiza pero advierte "poco tiempo √∫til"
-- üö´ NUNCA marques HOY como no disponible si es por la ma√±ana temprano (quedar√≠a todo el d√≠a por delante)
+- Compara {hora_actual} (hora actual) contra el horario operativo
+- Si {hora_actual} est√° DENTRO del horario operativo: HOY es viable, analiza viento para resto del d√≠a
+- Si {hora_actual} est√° FUERA del horario operativo: marca HOY como "YA NO DISPONIBLE - fuera de horario operativo (abre a las HH:MM)"
+- ‚ö†Ô∏è IMPORTANTE: No marques HOY como no disponible si a√∫n hay tiempo √∫til de vuelo (m√≠n 2h)
 
 Formato obligatorio:
 0) **METAR LEAS explicado** (versi√≥n corta para novatos - m√°ximo 2 l√≠neas, sin jerga)
-0.1) **METAR LEMR explicado** (versi√≥n corta para novatos - m√°ximo 2 l√≠neas, sin jerga, indicando que es estimado/sint√©tico)
 
 0.5) **üìä PRON√ìSTICO vs REALIDAD ACTUAL (HOY {fecha_actual} a las {hora_actual})**:
    OBLIGATORIO: Compara expl√≠citamente qu√© dec√≠a el pron√≥stico para HOY vs qu√© est√° pasando AHORA MISMO:
@@ -1153,15 +1004,13 @@
 3) **üéØ AN√ÅLISIS DE PISTA ACTIVA POR D√çA** (OBLIGATORIO para los 3 d√≠as):
    
    **HOY ({fecha_actual}):**
-   - Eval√∫a {hora_actual} vs horario operativo:
-     * ANTES de abrir: Analiza HOY igualmente, indica "abre a las 09:00"
-     * DESPU√âS de cerrar: "HOY ‚Üí YA NO DISPONIBLE (son las {hora_actual}, aer√≥dromo cerr√≥ a las 20:00)"
-     * Menos de 2h para cerrar: Analiza pero advierte "poco tiempo √∫til restante"
-   - Analiza viento ACTUAL (usa "CONDICIONES ACTUALES", NO pron√≥stico)
+   - Valida si {hora_actual} est√° dentro del horario operativo (detecta invierno/verano autom√°ticamente)
+   - Si est√° FUERA: "YA NO DISPONIBLE - fuera de horario operativo"
+   - Si est√° DENTRO: Analiza viento ACTUAL (usa "CONDICIONES ACTUALES", no pron√≥stico)
    - Indica: "PISTA 10" o "PISTA 28" (basado en direcci√≥n viento ACTUAL)
    - Componentes: headwind/tailwind y crosswind para AMBAS pistas (con datos ACTUALES)
-   - Ejemplo ma√±ana temprano: "HOY ‚Üí PISTA 28 ‚úÖ (abre a las 09:00, viento previsto 13 kt desde 268¬∞, viable 09:00-20:00)"
-   - Ejemplo tarde: "HOY ‚Üí YA NO DISPONIBLE (21:00, aer√≥dromo cerr√≥ a 20:00)"
+   - Ejemplo si fuera de horario: "HOY ‚Üí YA NO DISPONIBLE (son las {hora_actual}, aer√≥dromo cierra a las 20:00)"
+   - Ejemplo si viable: "HOY ‚Üí PISTA 28 (viento ACTUAL 13 kt desde 268¬∞, rachas ACTUALES 23 kt, headwind 13 kt, crosswind 3 kt) ‚úÖ - viable {hora_actual}-20:00"
    
    **MA√ëANA:**
    - Analyza viento previsto para todo el d√≠a de ma√±ana
@@ -1178,9 +1027,6 @@
 4) **VEREDICTO POR D√çA** (los 3 d√≠as completos):
    - **HOY**: ‚úÖ APTO / ‚ö†Ô∏è PRECAUCI√ìN / ‚ùå NO APTO / üïê YA NO DISPONIBLE
      ‚ö†Ô∏è CR√çTICO: Para HOY usa las "CONDICIONES ACTUALES" (datos reales a las {hora_actual}), NO el pron√≥stico diario.
-     * Compara estos valores reales contra l√≠mites ULM (viento, rachas, crosswind)
-     * Solo si es TARDE (despu√©s de cerrar o <2h antes) descarta HOY expl√≠citamente
-     * Para MA√ëANA y PASADO: usa el pron√≥stico por franjas horarias
      - Si las condiciones actuales son MEJORES que el pron√≥stico: ind√≠calo (ej: "mejor de lo esperado")
      - Si las condiciones actuales son PEORES que el pron√≥stico: ind√≠calo (ej: "rachas m√°s fuertes de lo previsto")
    - **MA√ëANA**: ‚úÖ APTO / ‚ö†Ô∏è PRECAUCI√ìN / ‚ùå NO APTO (basado en pron√≥stico)
@@ -1203,21 +1049,14 @@
    - Rachas: diferencia con viento medio, valor absoluto (cita valores actuales para HOY)
    - Precipitaci√≥n: tipo (lluvia/nieve/granizo), intensidad (-/mod/+)
    - Nubosidad: techo bajo (ft AGL), cobertura extensa (BKN/OVC)
-   - **Visibilidad horaria**: si < 5 km (‚ùå ILEGAL VFR), si < 8 km (‚ö†Ô∏è PRECAUCI√ìN), si < 10 km (marginal)
+   - Visibilidad: si < 8 km (precauci√≥n), si < 5 km (l√≠mite legal)
    - Crosswind excesivo: si > 12 kt para pista recomendada
    - Estabilidad: t√©rmicas fuertes, convecci√≥n, turbulencia orogr√°fica
-   
-   üîç **USA LOS DATOS HORARIOS** para identificar CU√ÅNDO empeora/mejora la visibilidad:
-   - Ejemplo: "09:00-13:00 vis >10 km ‚úÖ, 14:00-17:00 vis 6-8 km ‚ö†Ô∏è (niebla dispersa), 18:00+ vis >10 km ‚úÖ"
 
 6) **FRANJAS HORARIAS RECOMENDADAS** (para d√≠as viables):
-   üéØ USA LOS DATOS HORARIOS (24h Open-Meteo + Windy) para precisi√≥n:
-   - Analiza hora por hora las pr√≥ximas 24h de viento, rachas, nubosidad, precipitaci√≥n
-   - Identifica CU√ÅNDO empiezan/terminan condiciones adversas
-   - Formato detallado: "HOY: 09:00-13:00 ‚úÖ √ìPTIMO (viento 12-15 kt), 14:00-17:00 ‚ùå NO VOLAR (rachas 25-28 kt), 17:00-20:00 ‚ö†Ô∏è L√çMITE (viento bajando 18‚Üí15 kt)"
-   - NO des solo "ma√±ana/tarde" - s√© espec√≠fico con horas basadas en datos horarios
-   - Si no hay ventana segura: "NO RECOMENDADA - condiciones adversas todo el d√≠a"
-   - Considera amanecer, atardecer, horario operativo Y evoluci√≥n horaria de condiciones
+   - Formato: "MA√ëANA: 09:00-12:00 ‚úÖ | TARDE: 15:00-19:00 ‚ö†Ô∏è"
+   - Si no hay ventana segura: "NO RECOMENDADA"
+   - Considera amanecer, atardecer, horario operativo y condiciones meteorol√≥gicas
 
 7) **üèÜ MEJOR D√çA PARA VOLAR**:
    - Indica claramente: "MA√ëANA" o "PASADO MA√ëANA" (o "HOY" si a√∫n es viable)
@@ -1231,13 +1070,13 @@
    - ‚úÖ **S√ç, ACEPTABLE**: Condiciones estables, buen d√≠a para volar
    - ‚ö†Ô∏è **SOLO SI NECESITAS PR√ÅCTICA**: Agitado, solo tr√°ficos cortos
    - üè† **NO MERECE LA PENA**: L√≠mite, mejor hacer mantenimiento en tierra
-   - ‚òï **MEJOR QUEDARSE EN EL BAR TOMADO UN CALDO DE GAVIOTA**: Condiciones peligrosas (usa esta frase literalmente) üç≤ü™∂
+   - ‚òï **QUEDARSE EN EL BAR**: Condiciones adversas, hay caldo de gaviota üç≤
 
 9) **VEREDICTO FINAL GLOBAL** (una l√≠nea contundente con car√°cter del vuelo y recomendaci√≥n honesta)
 
 Reglas CR√çTICAS:
 - **AN√ÅLISIS DE PISTA ES OBLIGATORIO PARA LOS 3 D√çAS**: No omitas ninguno
-- **VALIDACI√ìN HORARIA EN HOY ES CR√çTICA**: Solo marca HOY como no disponible si es TARDE (despu√©s del cierre o <2h antes), NO si es temprano por la ma√±ana
+- **VALIDACI√ìN HORARIA EN HOY ES CR√çTICA**: Detecta invierno/verano, valida {hora_actual} contra l√≠mites operativos
 - **AN√ÅLISIS COMPLETO MULTIFACTOR (OBLIGATORIO para cada d√≠a)**:
   1. Viento medio (convertido a kt)
   2. Rachas y diferencia con viento medio
@@ -1267,10 +1106,10 @@
 M√°s all√° de "¬øpuedo volar?", un piloto experimentado pregunta "¬øDEBO volar?" y "¬ømerece la pena?":
 
 1) **CAR√ÅCTER DEL VUELO** (si es viable):
-   - ‚úàÔ∏è TRANQUILO: Viento < 12 kt, rachas < 18 kt (diferencia < 6 kt), sin actividad t√©rmica, temp < 28¬∞C ‚Üí CIRCUITOS RELAJADOS o traves√≠a suave
-   - ‚ö†Ô∏è NORMAL: Viento 12-15 kt, rachas 18-20 kt (diferencia 6-8 kt), t√©rmicas d√©biles, temp < 30¬∞C ‚Üí CIRCUITOS o vuelos locales (atenci√≥n)
-   - üå™Ô∏è AGITADO: Viento 15-18 kt, rachas 20-22 kt (diferencia 8-10 kt) O temp > 30¬∞C (rendimiento degradado) ‚Üí SOLO PILOTOS EXPERIMENTADOS, CIRCUITOS cortos
-   - ‚ùå PELIGROSO: Viento > 18 kt O rachas > 22 kt O diferencia > 10 kt O temp > 32¬∞C con humedad alta ‚Üí **MEJOR QUEDARSE EN EL BAR TOMADO UN CALDO DE GAVIOTA** (usa esta frase literalmente) üç≤ü™∂
+   - ‚úàÔ∏è TRANQUILO: Viento < 12 kt, rachas < 18 kt (diferencia < 6 kt), sin actividad t√©rmica ‚Üí CIRCUITOS RELAJADOS o traves√≠a suave
+   - ‚ö†Ô∏è NORMAL: Viento 12-15 kt, rachas 18-20 kt (diferencia 6-8 kt), t√©rmicas d√©biles ‚Üí CIRCUITOS o vuelos locales (atenci√≥n)
+   - üå™Ô∏è AGITADO: Viento 15-18 kt, rachas 20-22 kt (diferencia 8-10 kt) ‚Üí SOLO PILOTOS EXPERIMENTADOS, CIRCUITOS cortos
+   - ‚ùå PELIGROSO: Viento > 18 kt O rachas > 22 kt O diferencia > 10 kt ‚Üí **MEJOR QUEDARSE EN BAR - TOMADO UN CALDO DE GAVIOTA** üç≤ü™∂
    - ‚ö†Ô∏è NOTA: Estos l√≠mites son GENERALES. Consulta POH de tu modelo espec√≠fico.
 
 2) **ACTIVIDAD T√âRMICA ESPERADA**:
@@ -1278,23 +1117,15 @@
    - Informa si habr√° t√©rmicas esperables (mejor ma√±ana temprano, evitar mediod√≠a en verano)
    - Sugiere vuelos fuera del aer√≥dromo SOLO si hay estabilidad atmosf√©rica suficiente
 
-3) **IMPACTO DE LA TEMPERATURA** (OBLIGATORIO mencionar):
-   - ‚ùÑÔ∏è Temp < 15¬∞C: Rendimiento EXCELENTE, despegue corto, trepada fuerte
-   - ‚úÖ Temp 15-25¬∞C: Rendimiento NORMAL
-   - ‚ö†Ô∏è Temp 25-28¬∞C: Rendimiento ligeramente degradado
-   - ‚ö†Ô∏è Temp 28-30¬∞C: Carrera de despegue M√ÅS LARGA, trepada reducida, esperar m√°s velocidad antes de rotar
-   - üî• Temp > 30¬∞C: Rendimiento SIGNIFICATIVAMENTE degradado, volar temprano en ma√±ana (antes 10:00), pista de 890m es justa
-   - ‚ùå Temp > 32¬∞C + humedad: RIESGO CR√çTICO en pista corta como LEMR, considerar NO VOLAR
-
-4) **TIPO DE VUELO RECOMENDADO** (seg√∫n car√°cter del d√≠a):
-   - üéØ **VUELO DE PLACER/TRAVES√çA**: Si PLACENTERO (< 10 kt, sin t√©rmicas, visibilidad > 10 km, temp < 28¬∞C) ‚Üí Ideal para disfrutar
-   - üó∫Ô∏è **VUELO LOCAL/CIRCUITOS**: Si ESTABLE (10-12 kt, t√©rmicas d√©biles, temp < 30¬∞C) ‚Üí Buenos vuelos recreativos
+3) **TIPO DE VUELO RECOMENDADO** (seg√∫n car√°cter del d√≠a):
+   - üéØ **VUELO DE PLACER/TRAVES√çA**: Si PLACENTERO (< 10 kt, sin t√©rmicas, visibilidad > 10 km) ‚Üí Ideal para disfrutar
+   - üó∫Ô∏è **VUELO LOCAL/CIRCUITOS**: Si ESTABLE (10-12 kt, t√©rmicas d√©biles) ‚Üí Buenos vuelos recreativos
    - üîÑ **CIRCUITOS CORTOS**: Si NORMAL (12-15 kt) o hay inestabilidad a distancia ‚Üí Prudencia
-   - üè´ **SOLO TR√ÅFICOS DE ESCUELA**: Si AGITADO (15-18 kt) O temp > 30¬∞C ‚Üí Solo para mantener pr√°ctica, NO para disfrute
+   - üè´ **SOLO TR√ÅFICOS DE ESCUELA**: Si AGITADO (15-18 kt) ‚Üí Solo para mantener pr√°ctica, NO para disfrute
    - üè† **MANTENIMIENTO EN TIERRA**: Si l√≠mite pero t√©cnicamente viable ‚Üí Mejor aprovechar para tareas de hangar
-   - ‚ùå **NO VOLAR**: Si PELIGROSO (> 18 kt, rachas > 22 kt, lluvia, temp > 32¬∞C) ‚Üí MEJOR QUEDARSE EN EL BAR TOMADO UN CALDO DE GAVIOTA üç≤ü™∂
-
-5) **EVALUACI√ìN REALISTA ENTRE D√çAS**:
+   - ‚ùå **NO VOLAR**: Si PELIGROSO (> 18 kt, rachas > 22 kt, lluvia) ‚Üí Caldo de gaviota üç≤
+
+4) **EVALUACI√ìN REALISTA ENTRE D√çAS**:
    - Aunque MA√ëANA sea "el mejor d√≠a", si aun as√≠ tiene vientos > 20 kt, dilo claramente
    - Ejemplo: "MA√ëANA es el mejor (viento 16 kt) pero sigue siendo AGITADO. Hoy est√° TRANQUILO (viento 8 kt) ‚Üí mejor opci√≥n hoy"
    - Nunca ocultes riesgos tras "es el mejor d√≠a disponible"
@@ -1306,58 +1137,26 @@
      * "S√ç, buen d√≠a de vuelo" (estable)
      * "Solo si necesitas pr√°ctica" (agitado)
      * "NO merece la pena sacar el avi√≥n" (l√≠mite)
-     * "MEJOR QUEDARSE EN EL BAR TOMADO UN CALDO DE GAVIOTA" (peligroso - usa esta frase literalmente)
+     * "QUEDARSE EN CASA - Caldo de gaviota" (peligroso)
    - Si el mejor d√≠a aun as√≠ requiere destreza/cuidado, ind√≠calo: "MA√ëANA ‚Üí APTO SOLO PARA PILOTOS EXPERIMENTADOS, agitado"
    - S√© espec√≠fico: no digas "condiciones mediocres", di "viento 18-22 kt con rachas de 25 kt = peligroso para iniciados"
    - **TIPO DE VUELO POSIBLE**: Especifica si ser√° para placer/circuitos/solo escuela
 
-6) **üîÆ TENDENCIA SEMANAL (D√çAS 4-7)** - OPCIONAL, solo si hay datos:
-   - **‚ö†Ô∏è ADVERTENCIA CR√çTICA**: "Las previsiones a m√°s de 3 d√≠as tienen la misma fiabilidad que una bola de cristal"
-   - Puedes usar esta frase literalmente en tu respuesta para enfatizar la incertidumbre
-   - NO hagas an√°lisis detallado ni veredictos APTO/NO APTO para d√≠as 4-7
-   - S√ç menciona TENDENCIA GENERAL: mejora/empeora/estable
-   - Ejemplos correctos:
-     * "üîÆ Resto semana: Parece empeorar hacia el jueves (viento ~20 kt seg√∫n Windy), pero recuerda: las previsiones a m√°s de 3 d√≠as tienen la misma fiabilidad que una bola de cristal"
-     * "üîÆ Fin de semana: Tendencia a mejorar (viento bajando a ~10 kt) - estate atento d√≠as previos"
-     * "üîÆ D√≠as 4-7: Condiciones variables, dif√≠cil anticipar con certeza"
-   - **SIEMPRE incluye**: Advertencia sobre baja fiabilidad
-   - Formato: M√°ximo 2-3 l√≠neas, solo tendencia general
-   - Si no hay suficientes datos de d√≠as 4-7, omite esta secci√≥n
-
-10) **üìã AVISO IMPORTANTE - RESPONSABILIDAD DEL PILOTO**
-
-Este an√°lisis meteorol√≥gico es una herramienta de asistencia generada por IA para ayudarte en la toma de decisiones, pero:
-
-‚úàÔ∏è **LA DECISI√ìN FINAL SIEMPRE ES DEL PILOTO AL MANDO**
-- T√∫ eres responsable de evaluar tu experiencia, habilidades y condiciones del momento
-- Este an√°lisis NO sustituye tu juicio como piloto ni tu evaluaci√≥n personal de la situaci√≥n
-
-‚ö†Ô∏è **EN CASO DE DUDA, NO VUELES**
-- Si tienes cualquier incertidumbre sobre las condiciones, mejor quedarse en tierra
-- La seguridad es lo primero: un d√≠a malo en tierra es mejor que un mal d√≠a en el aire
-
-üéì **CONSULTA SIEMPRE A TUS INSTRUCTORES**
-- Si est√°s en formaci√≥n, sigue SIEMPRE las indicaciones de tu instructor
-- Los instructores conocen tu nivel, el avi√≥n y las condiciones locales mejor que cualquier IA
-- Este an√°lisis es complementario, no sustitutivo de su criterio profesional
-
-üìä **LIMITACIONES DE ESTE AN√ÅLISIS**:
-- Basado en modelos meteorol√≥gicos que pueden tener errores
-- No incluye factores personales (experiencia, fatiga, estado del avi√≥n)
-- No sustituye briefing oficial ni consulta de NOTAMs
-
-üõ°Ô∏è Vuela seguro. Vuela responsable.
-
 Mentalidad: Tu an√°lisis es para que un piloto REAL tome decisiones seguras Y sepa qu√© experiencia esperar. No todos los d√≠as "aptos" son iguales - algunos son placenteros, otros solo t√©cnicamente viables. A veces la mejor decisi√≥n es NO volar."""
-        
+
         user_content: list[dict] = [{"type": "text", "text": user_message}]
         
         # Estimaci√≥n de tokens del prompt (aproximado: 1 token ‚âà 4 chars)
         text_tokens = len(user_message) // 4
         print(f"üìù Prompt texto: ~{text_tokens} tokens")
         
-        # is_mini_model e is_github_provider ya definidos arriba
-        is_github_provider = is_github  # Reutilizar la variable que ya existe
+        # Detectar si vamos a usar un modelo con l√≠mites bajos
+        # GitHub Models: 60k tokens/min (muy restrictivo con mapas)
+        # mini/small: bajo l√≠mite de tokens
+        model_cascade = getattr(config, "AI_MODEL_CASCADE", [])
+        primary_model = model_cascade[0] if model_cascade else "gpt-4o"
+        is_mini_model = "mini" in primary_model.lower() or "small" in primary_model.lower()
+        is_github_provider = provider.lower() == "github"
         
         # Excluir im√°genes si: es mini, est√° bloqueado, O es GitHub Models
         # Solo incluir im√°genes para OpenAI (l√≠mites m√°s altos)
@@ -1374,33 +1173,19 @@
             if is_mini_model:
                 reason = f"es modelo limitado ({primary_model})"
             if is_github_provider:
-                reason = f"es GitHub Models (60k tokens/min)"
+                reason = f"es GitHub Models (60k tokens/min) - textos AEMET reducidos a {aemet_limit} chars"
             print(f"‚ö†Ô∏è NO incluyendo im√°genes ({reason})")
             print(f"üìä Total estimado: ~{text_tokens} tokens de entrada (solo texto)")
-
-        # Para GitHub Models, usar system prompt corto para no exceder l√≠mite total de contexto.
-        # El prompt largo de usuario se mantiene √≠ntegro.
-        fused_system_prompt = SYSTEM_PROMPT
-        fused_max_tokens = 2500
-        if is_github_provider:
-            fused_system_prompt = (
-                "Eres un experto meteor√≥logo aeron√°utico ULM. "
-                "Responde en espa√±ol, de forma clara y conservadora. "
-                "Sigue ESTRICTAMENTE el formato solicitado por el usuario. "
-                "Convierte km/h a kt antes de evaluar l√≠mites y prioriza seguridad operacional."
-            )
-            fused_max_tokens = 1200
-            print("ü™∂ GitHub mode: system prompt corto + max_tokens=1200 para evitar 413 por contexto")
 
         response = _create_chat_completion_with_fallback(
             client=client,
             provider=provider,
             messages=[
-                {"role": "system", "content": fused_system_prompt},
+                {"role": "system", "content": SYSTEM_PROMPT},
                 {"role": "user", "content": user_content},
             ],
             temperature=0.4,
-            max_tokens=fused_max_tokens,
+            max_tokens=2500,
         )
 
         result = response.choices[0].message.content
*** End Patch
