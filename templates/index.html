<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- SEO Meta Tags -->
  <title>LEMR Meteo | La Morgal - Meteorolog√≠a Aer√≥dromo de La Morgal</title>
  <meta name="description" content="Informaci√≥n meteorol√≥gica en tiempo real del Aer√≥dromo de La Morgal (LEMR). Consulta METAR, pron√≥sticos AEMET, mapas de viento y condiciones para vuelo." />
  <meta name="keywords" content="LEMR, meteo, meteorolog√≠a, aer√≥dromo de la morgal, la morgal, METAR, AEMET, tiempo asturias, aviaci√≥n, pron√≥stico vuelo" />
  <meta name="author" content="LEMR Meteo" />
  <meta name="robots" content="index, follow" />
  <meta name="language" content="Spanish" />
  <meta name="revisit-after" content="1 days" />
  <meta name="theme-color" content="#0b1220" />
  
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üå§Ô∏è</text></svg>" />
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üå§Ô∏è</text></svg>" />
  
  <!-- Open Graph / Facebook / WhatsApp -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://lemr-meteo.evaristorivieccio.com/" />
  <meta property="og:title" content="LEMR Meteo | La Morgal - Meteorolog√≠a Aer√≥dromo de La Morgal" />
  <meta property="og:description" content="Informaci√≥n meteorol√≥gica en tiempo real del Aer√≥dromo de La Morgal (LEMR). Consulta METAR, pron√≥sticos AEMET y condiciones para vuelo." />
  <meta property="og:image" content="https://lemr-meteo.evaristorivieccio.com/static/og-image.jpg" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:locale" content="es_ES" />
  <meta property="og:site_name" content="LEMR Meteo" />
  
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:url" content="https://lemr-meteo.evaristorivieccio.com/" />
  <meta name="twitter:title" content="LEMR Meteo | La Morgal - Meteorolog√≠a Aer√≥dromo de La Morgal" />
  <meta name="twitter:description" content="Informaci√≥n meteorol√≥gica en tiempo real del Aer√≥dromo de La Morgal (LEMR). Consulta METAR, pron√≥sticos AEMET y condiciones para vuelo." />
  <meta name="twitter:image" content="https://lemr-meteo.evaristorivieccio.com/static/og-image.jpg" />
  
  <!-- Canonical URL -->
  <link rel="canonical" href="https://lemr-meteo.evaristorivieccio.com/" />
  
  <!-- Marked.js para renderizar markdown del an√°lisis IA -->
  <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
  
  <style>
    :root {
      color-scheme: dark;
      --bg: #0b1220;
      --bg2: #111a2b;
      --card: rgba(20, 31, 49, 0.82);
      --text: #e9f0ff;
      --muted: #9fb2cc;
      --accent: #66e3ff;
      --accent2: #8d7cff;
      --ok: #3ddc97;
      --warn: #ffd166;
      --danger: #ff6b6b;
      --border: rgba(255, 255, 255, 0.12);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: Inter, Segoe UI, Roboto, system-ui, sans-serif;
      background: radial-gradient(circle at 20% 10%, #1c2c47 0%, var(--bg) 45%), linear-gradient(130deg, var(--bg), var(--bg2));
      color: var(--text);
      min-height: 100vh;
    }

    .container {
      max-width: 1260px;
      margin: 0 auto;
      padding: 20px;
      display: grid;
      gap: 16px;
    }

    .hero {
      border: 1px solid var(--border);
      background: linear-gradient(135deg, rgba(102, 227, 255, 0.11), rgba(141, 124, 255, 0.12));
      backdrop-filter: blur(8px);
      border-radius: 18px;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
    }

    .hero-content {
      flex: 1;
      min-width: 280px;
    }

    .hero h1 {
      margin: 0 0 8px;
      font-size: clamp(1.4rem, 2.2vw, 2.1rem);
    }

    .nav-menu {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .nav-menu a {
      color: var(--text);
      text-decoration: none;
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 0.88rem;
      transition: all 0.2s ease;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid transparent;
    }

    .nav-menu a:hover {
      background: rgba(102, 227, 255, 0.15);
      border-color: rgba(102, 227, 255, 0.3);
      transform: translateY(-1px);
    }

    .scroll-to-top {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 24px;
      color: #fff;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      transition: all 0.3s ease;
      opacity: 0;
      visibility: hidden;
      z-index: 1000;
    }

    .scroll-to-top.visible {
      opacity: 1;
      visibility: visible;
    }

    .scroll-to-top:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 20px rgba(102, 227, 255, 0.5);
    }

    .muted { color: var(--muted); }

    .grid {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(290px, 1fr));
    }

    .grid-asturias {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(3, 1fr);
      margin-bottom: 16px;
    }

    .grid-llanera {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(4, 1fr);
    }

    @media (max-width: 1024px) {
      .grid-asturias {
        grid-template-columns: repeat(auto-fit, minmax(290px, 1fr));
      }
      .grid-llanera {
        grid-template-columns: repeat(auto-fit, minmax(290px, 1fr));
      }
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      overflow: hidden;
    }

    h2 {
      margin: 0 0 12px;
      font-size: 1.05rem;
      color: var(--accent);
    }

    h3 {
      margin: 12px 0 6px;
      font-size: 0.92rem;
      color: var(--accent2);
    }

    .kv {
      margin: 0;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 7px 12px;
      font-size: 0.95rem;
    }

    .kv dt { color: var(--muted); }
    .kv dd { margin: 0; font-weight: 600; }

    .days {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
    }

    .day {
      border: 1px solid var(--border);
      border-radius: 16px;
      overflow: hidden;
      background: rgba(9, 17, 32, 0.74);
    }

    .day-dual {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0;
    }

    .day-half {
      position: relative;
    }

    .day-half:first-child {
      border-right: 1px solid var(--border);
    }

    .day-half .day-head {
      padding: 12px 14px;
      background: linear-gradient(90deg, rgba(102, 227, 255, 0.15), rgba(141, 124, 255, 0.14));
      font-weight: 700;
    }

    .day-half .day-body {
      padding: 12px 14px;
      display: grid;
      gap: 10px;
    }

    @media (max-width: 768px) {
      .day-dual {
        grid-template-columns: 1fr;
      }
      .day-half:first-child {
        border-right: none;
        border-bottom: 1px solid var(--border);
      }
    }

    .day-head {
      padding: 12px 14px;
      background: linear-gradient(90deg, rgba(102, 227, 255, 0.15), rgba(141, 124, 255, 0.14));
      font-weight: 700;
    }

    .day-body {
      padding: 12px 14px;
      display: grid;
      gap: 10px;
    }

    .chip {
      display: inline-block;
      padding: 5px 9px;
      border-radius: 99px;
      border: 1px solid var(--border);
      font-size: 0.78rem;
      color: var(--muted);
      margin: 2px 4px 2px 0;
    }

    .map-pair {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 8px;
    }

    .map-slot {
      text-align: center;
    }

    .map-slot .label {
      font-size: 0.72rem;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .map {
      width: 100%;
      border-radius: 10px;
      border: 1px solid var(--border);
      min-height: 120px;
      object-fit: contain;
      background: #0c1525;
      cursor: pointer;
    }

    .analysis-map {
      max-width: 680px;
      margin: 0 auto;
      display: block;
    }

    .analysis-map.rotated {
      transform: rotate(90deg);
      transform-origin: center center;
      max-width: min(85vw, 900px);
    }

    .analysis {
      line-height: 1.7;
      font-size: 0.93rem;
      margin: 0;
      color: #dce7ff;
    }

    .analysis h2, .analysis h3, .analysis h4 {
      color: var(--accent);
      margin-top: 1.2em;
      margin-bottom: 0.6em;
      font-weight: 600;
    }

    .analysis h2 { font-size: 1.1rem; }
    .analysis h3 { font-size: 1rem; }
    .analysis h4 { font-size: 0.95rem; }

    .analysis strong {
      color: var(--accent);
      font-weight: 600;
    }

    .analysis p {
      margin: 0.8em 0;
    }

    .analysis ul, .analysis ol {
      margin: 0.6em 0;
      padding-left: 1.5em;
    }

    .analysis li {
      margin: 0.4em 0;
    }

    .analysis code {
      background: rgba(102, 227, 255, 0.1);
      padding: 0.15em 0.4em;
      border-radius: 3px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 0.9em;
    }

    .analysis pre {
      background: rgba(0, 0, 0, 0.3);
      padding: 0.8em;
      border-radius: 6px;
      overflow-x: auto;
      border-left: 3px solid var(--accent);
    }

    .analysis blockquote {
      border-left: 3px solid var(--accent2);
      padding-left: 1em;
      margin: 1em 0;
      color: var(--muted);
      font-style: italic;
    }

    .pred-text {
      white-space: pre-wrap;
      font-size: 0.88rem;
      color: var(--muted);
      line-height: 1.4;
      margin: 4px 0 0;
      max-height: 300px;
      overflow-y: auto;
    }

    .table-wrap {
      overflow-x: auto;
      border: 1px solid var(--border);
      border-radius: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.86rem;
    }

    th, td {
      padding: 8px;
      border-bottom: 1px solid var(--border);
      text-align: left;
      white-space: nowrap;
    }

    th {
      color: var(--accent2);
      font-weight: 700;
    }

    .windy-map {
      width: 100%;
      min-height: 360px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #0c1525;
    }

    .control-row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .control-row select,
    .control-row button {
      background: #0f1a2d;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 0.88rem;
    }

    .footer {
      font-size: 0.86rem;
      color: var(--muted);
      text-align: center;
      margin-top: 10px;
    }

    .pwa-tip {
      display: none;
      background: rgba(102, 227, 255, 0.08);
      border: 1px solid rgba(102, 227, 255, 0.2);
      border-radius: 10px;
      padding: 12px 16px;
      margin: 16px auto 12px;
      max-width: 600px;
      font-size: 0.85rem;
      line-height: 1.5;
    }

    .pwa-tip strong {
      color: var(--accent);
      display: block;
      margin-bottom: 4px;
    }

    @media (max-width: 768px) {
      .pwa-tip {
        display: block;
      }
    }

    a { color: var(--accent); }

    /* Estilos para Ogimet - Vista Semanal */
    .ogimet-week-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }

    .ogimet-day-card {
      background: rgba(20, 31, 49, 0.65);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
    }

    .ogimet-day-card:hover {
      transform: translateY(-4px);
      border-color: var(--accent);
      box-shadow: 0 8px 24px rgba(102, 227, 255, 0.15);
    }

    .ogimet-day-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }

    .ogimet-day-label {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--accent);
    }

    .ogimet-day-date {
      font-size: 0.85rem;
      color: var(--muted);
    }

    .ogimet-map-preview {
      width: 100%;
      border-radius: 8px;
      border: 1px solid var(--border);
      min-height: 180px;
      object-fit: cover;
      background: #0c1525;
    }

    .ogimet-info {
      margin-top: 8px;
      font-size: 0.8rem;
      color: var(--muted);
      text-align: center;
    }

    .ogimet-loading {
      text-align: center;
      padding: 40px;
      color: var(--muted);
    }

    .ogimet-error {
      background: rgba(255, 107, 107, 0.1);
      border: 1px solid var(--danger);
      border-radius: 8px;
      padding: 16px;
      color: var(--danger);
      text-align: center;
    }

    .ogimet-run-info {
      font-size: 0.85rem;
      color: var(--muted);
      margin-bottom: 12px;
      padding: 8px 12px;
      background: rgba(102, 227, 255, 0.05);
      border-radius: 6px;
      border-left: 3px solid var(--accent);
    }

    /* Modal para ampliar im√°genes de Ogimet */
    .ogimet-modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.9);
      animation: fadeIn 0.3s;
    }

    .ogimet-modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .ogimet-modal-content {
      max-width: 95%;
      max-height: 95%;
      margin: auto;
      display: block;
      border-radius: 8px;
    }

    .ogimet-modal-close {
      position: absolute;
      top: 20px;
      right: 40px;
      color: #fff;
      font-size: 40px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
    }

    .ogimet-modal-close:hover {
      color: var(--accent);
    }

    .ogimet-modal-info {
      text-align: center;
      color: #fff;
      padding: 16px;
      font-size: 1.1rem;
    }

    @media (max-width: 600px) {
      .map-pair { grid-template-columns: 1fr; }
      .days { grid-template-columns: 1fr; }
      .ogimet-week-grid { grid-template-columns: 1fr; }
    }

    @media (max-width: 768px) {
      .hero {
        flex-direction: column;
        align-items: flex-start;
      }
      .nav-menu {
        width: 100%;
        justify-content: flex-start;
      }
    }
  </style>
</head>
<body>
  <main class="container">
    <!-- HERO -->
    <section class="hero">
      <div class="hero-content">
        <h1>üõ©Ô∏è LEMR Meteo ¬∑ La Morgal</h1>
        <div class="muted" id="meta-line"></div>
        <div class="muted" id="refresh-line"></div>
        <div class="muted" id="load-status">‚è≥ Cargando datos meteorol√≥gicos...</div>
      </div>
      <nav class="nav-menu">
        <a href="#condiciones">üå§Ô∏è Actual</a>
        <a href="#windy">üå¨Ô∏è Windy</a>
        <a href="#pronostico">üìÖ 3 d√≠as</a>
        <a href="#aemet-asturias">üå¶Ô∏è AEMET</a>
        <a href="#analisis-ia">üë®‚Äç‚úàÔ∏è IA</a>
        <a href="#mapa-analisis">üó∫Ô∏è Mapa</a>
        <a href="#ogimet-semana">üìÜ 7 d√≠as</a>
      </nav>
    </section>

    <!-- TOP CARDS -->
    <section class="grid" id="condiciones">
      <article class="card">
        <h2>üìç Aer√≥dromo</h2>
        <dl class="kv" id="aerodrome-kv"></dl>
      </article>

      <article class="card">
        <h2>üå§Ô∏è Condiciones actuales</h2>
        <dl class="kv" id="current-kv"></dl>
      </article>

      <article class="card">
        <h2>‚úàÔ∏è METAR LEAS (referencia oficial)</h2>
        <p id="metar-leas-raw" class="analysis" style="font-family:monospace;font-size:0.88rem;background:rgba(0,0,0,.3);padding:8px;border-radius:8px;margin-bottom:8px"></p>
        <p id="metar-leas-category" style="font-size:0.9rem;font-weight:600;margin:0"></p>
      </article>

      <article class="card">
        <h2>üéØ METAR LEMR (estimado autom√°tico)</h2>
        <p id="metar-lemr-raw" class="analysis" style="font-family:monospace;font-size:0.88rem;background:rgba(0,0,0,.3);padding:8px;border-radius:8px;margin-bottom:8px"></p>
        <p id="metar-lemr-category" style="font-size:0.9rem;font-weight:600;margin:0;margin-bottom:8px"></p>
        <p id="metar-lemr-disclaimer" class="muted" style="font-size:0.8rem;line-height:1.4;margin:0"></p>
      </article>
    </section>

    <!-- WINDY POINT FORECAST -->
    <section class="card" id="windy">
      <h2>üå¨Ô∏è Windy Point Forecast (La Morgal)</h2>
      <div class="control-row">
        <label for="windy-model" class="muted">Modelo:</label>
        <select id="windy-model"></select>
      </div>
      <p class="muted" id="windy-meta"></p>
      <p class="analysis" id="windy-error" style="display:none;color:var(--warn)"></p>
      <iframe id="windy-map" class="windy-map" title="Mapa Windy La Morgal" loading="lazy"></iframe>
      <p class="muted" style="margin-top:8px">
        Abrir en Windy: <a id="windy-map-link" href="#" target="_blank" rel="noopener noreferrer">enlace directo</a>
      </p>
    </section>

    <!-- TRES D√çAS CON MAPAS SIGNIFICATIVOS -->
    <section class="card" id="pronostico">
      <h2>üìÖ Pron√≥stico 3 d√≠as con mapas significativos AEMET</h2>
      <div id="days" class="days"></div>
    </section>

    <!-- PREDICCI√ìN AEMET TEXTUAL -->
    <section class="grid-asturias" id="aemet-asturias">
      <article class="card">
        <h2 id="pred-ast-hoy-title">üå¶Ô∏è Predicci√≥n AEMET ‚Äî Asturias hoy</h2>
        <p id="pred-ast-hoy" class="pred-text"></p>
      </article>
      <article class="card">
        <h2 id="pred-ast-man-title">üå¶Ô∏è Predicci√≥n AEMET ‚Äî Asturias ma√±ana</h2>
        <p id="pred-ast-man" class="pred-text"></p>
      </article>
      <article class="card">
        <h2 id="pred-ast-pas-title">üå¶Ô∏è Predicci√≥n AEMET ‚Äî Asturias pasado ma√±ana</h2>
        <p id="pred-ast-pas" class="pred-text"></p>
      </article>
    </section>

    <section class="grid-llanera" id="aemet-llanera">
      <article class="card">
        <h2 id="pred-llanera-0-title">üèîÔ∏è Predicci√≥n AEMET ‚Äî Llanera (La Morgal) hoy</h2>
        <p id="pred-llanera-0" class="pred-text"></p>
      </article>
      <article class="card">
        <h2 id="pred-llanera-1-title">üèîÔ∏è Predicci√≥n AEMET ‚Äî Llanera (La Morgal) ma√±ana</h2>
        <p id="pred-llanera-1" class="pred-text"></p>
      </article>
      <article class="card">
        <h2 id="pred-llanera-2-title">üèîÔ∏è Predicci√≥n AEMET ‚Äî Llanera (La Morgal) pasado ma√±ana</h2>
        <p id="pred-llanera-2" class="pred-text"></p>
      </article>
      <article class="card">
        <h2 id="pred-llanera-3-title">üèîÔ∏è Predicci√≥n AEMET ‚Äî Llanera (La Morgal) 3¬∫ d√≠a</h2>
        <p id="pred-llanera-3" class="pred-text"></p>
      </article>
    </section>

    <section class="card" id="analisis-ia">
      <h2>üë®‚Äç‚úàÔ∏è An√°lisis IA</h2>
      <div id="expert-final" class="analysis"></div>
    </section>

    <!-- MAPA AN√ÅLISIS EN SUPERFICIE -->
    <section class="card" id="mapa-analisis">
      <h2>üó∫Ô∏è Mapa de an√°lisis en superficie (isobaras + frentes)</h2>
      <img id="analysis-map-img" class="map analysis-map" alt="Mapa de an√°lisis AEMET" style="display:none" />
      <p id="analysis-map-unavailable" class="muted" style="text-align:center">üó∫Ô∏è Mapa no disponible en este momento</p>
    </section>

    <!-- OGIMET - VISTA SEMANAL -->
    <section class="card" id="ogimet-semana">
      <h2>üó∫Ô∏è Previsi√≥n de superficie 7 d√≠as (Ogimet GFS)</h2>
      <div id="ogimet-run-info" class="ogimet-run-info" style="display:none"></div>
      <div id="ogimet-week-container" class="ogimet-loading">
        <div>‚è≥ Cargando previsi√≥n semanal...</div>
      </div>
      <div style="font-size: 0.75rem; color: var(--muted); margin-top: 12px; text-align: center;">
        üìä Datos de <a href="https://www.ogimet.com" target="_blank" style="color: var(--accent);">Ogimet</a> 
        (Modelo GFS) ¬∑ Solo informativo, verificar con AEMET antes de volar
      </div>
    </section>

    <!-- Modal para ampliar im√°genes de Ogimet -->
    <div id="ogimetModal" class="ogimet-modal">
      <span class="ogimet-modal-close" onclick="closeOgimetModal()">&times;</span>
      <img class="ogimet-modal-content" id="ogimetModalImg">
      <div class="ogimet-modal-info" id="ogimetModalInfo"></div>
    </div>

    <div class="footer">
      <div class="pwa-tip">
        <strong>üí° Tip: √ösala como una app</strong>
        Si est√°s en Chrome, toca el men√∫ (‚ãÆ) y selecciona "A√±adir a pantalla de inicio".
        Podr√°s abrirla como una app sin navegador.
      </div>
      Datos de <a href="https://opendata.aemet.es" target="_blank">AEMET OpenData</a>,
      <a href="https://aviationweather.gov" target="_blank">Aviation Weather</a>,
      <a href="https://open-meteo.com" target="_blank">Open-Meteo</a>,
      <a href="https://www.windy.com" target="_blank">Windy</a> y
      <a href="https://www.ogimet.com" target="_blank">Ogimet</a>.
      Actualizaci√≥n autom√°tica ¬∑ cada hora de 06:00 a 23:00 (Europe/Madrid).
    </div>

    <footer style="
      margin-top: 24px;
      padding: 20px 16px;
      border-top: 1px solid var(--border);
      text-align: center;
      font-size: 0.78rem;
      color: var(--muted);
      line-height: 1.7;
    ">
      <p style="margin: 0 0 6px;">
        ‚ö†Ô∏è <strong style="color: var(--text);">Aviso legal</strong> ¬∑ Proyecto personal y experimental desarrollado por <a href="https://www.evaristorivieccio.com/" target="_blank" rel="noopener noreferrer">Evaristo R.</a> para investigar aplicaciones de IA en meteorolog√≠a.
        Aunque utiliza datos de fuentes oficiales, los an√°lisis generados por IA no constituyen informaci√≥n oficial y pueden contener errores.
      </p>
      <p style="margin: 0 0 6px;">
        Este sitio no est√° afiliado ni respaldado por LEMR, La Morgal ni ninguna entidad oficial.
        Contenido √∫nicamente informativo y educativo.
      </p>
      <p style="margin: 0 0 6px;">
        El uso de la informaci√≥n se realiza bajo responsabilidad del usuario.
      </p>
      <p style="margin: 0; font-size: 0.73rem; color: var(--muted);">
        üç™ Este sitio no utiliza cookies ni almacena datos personales de ning√∫n tipo.
      </p>
    </footer>
  </main>

  <!-- Bot√≥n flotante de vuelta al inicio -->
  <div class="scroll-to-top" id="scrollToTop" title="Volver al inicio">‚Üë</div>

  <script>
    const state = {
      data: {{ data | tojson }},
      windyModel: null,
    };

    // Smooth scroll para el men√∫ de navegaci√≥n
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.nav-menu a').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
          e.preventDefault();
          const targetId = this.getAttribute('href').substring(1);
          const targetElement = document.getElementById(targetId);
          if (targetElement) {
            // Verificar si la secci√≥n est√° oculta (mapa de an√°lisis)
            if (targetElement.style.display === 'none') {
              return; // No hacer scroll si est√° oculto
            }
            const offset = 20; // Espacio superior
            const elementPosition = targetElement.getBoundingClientRect().top;
            const offsetPosition = elementPosition + window.pageYOffset - offset;
            
            window.scrollTo({
              top: offsetPosition,
              behavior: 'smooth'
            });
          }
        });
      });

      // Bot√≥n scroll to top
      const scrollToTopBtn = document.getElementById('scrollToTop');
      
      // Mostrar/ocultar bot√≥n seg√∫n scroll
      window.addEventListener('scroll', () => {
        if (window.pageYOffset > 300) {
          scrollToTopBtn.classList.add('visible');
        } else {
          scrollToTopBtn.classList.remove('visible');
        }
      });

      // Acci√≥n del bot√≥n
      scrollToTopBtn.addEventListener('click', () => {
        window.scrollTo({
          top: 0,
          behavior: 'smooth'
        });
      });
    });

    const setLoadStatus = (text, isError = false) => {
      const el = document.getElementById("load-status");
      if (!el) return;
      if (!text) {
        el.style.display = "none";
        return;
      }
      el.style.display = "";
      el.textContent = text;
      el.style.color = isError ? "var(--warn)" : "var(--muted)";
    };

    const fmtDateTime = (v) => {
      if (!v) return "N/A";
      try { return new Date(v).toLocaleString("es-ES", { hour12: false }); } catch { return v; }
    };

    const hhmm = (v) => {
      if (!v) return "N/A";
      const i = v.indexOf("T");
      return i === -1 ? v : v.slice(i + 1, i + 6);
    };

    const renderKv = (id, entries) => {
      document.getElementById(id).innerHTML = entries.map(([k,v]) => `<dt>${k}</dt><dd>${v ?? "N/A"}</dd>`).join("");
    };

    const mapImg = (b64, url, alt) => {
      if (url) {
        return `<a href="${url}" target="_blank" rel="noopener noreferrer"><img class="map" src="${url}" alt="${alt}" loading="lazy" referrerpolicy="no-referrer" /></a>`;
      }
      if (b64) {
        const src = `data:image/png;base64,${b64}`;
        return `<a href="${src}" target="_blank" rel="noopener noreferrer"><img class="map" src="${src}" alt="${alt}" loading="lazy" /></a>`;
      }
      return `<div class="map" style="display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:.8rem">Mapa no disponible para este tramo</div>`;
    };

    const renderDays = (days) => {
      const result = [];
      let i = 0;
      
      while (i < days.length) {
        const d = days[i];
        const next = i + 1 < days.length ? days[i + 1] : null;
        
        // Si este d√≠a y el siguiente no tienen mapas, combinarlos
        if (!d.show_aemet_maps && next && !next.show_aemet_maps) {
          result.push(`
            <article class="day day-combined">
              <div class="day-dual">
                <div class="day-half">
                  <div class="day-head">${d.label} ¬∑ ${d.date}</div>
                  <div class="day-body">
                    <div>
                      <span class="chip">${d.description}</span>
                      <span class="chip">üå°Ô∏è ${d.temp_min}¬∞C / ${d.temp_max}¬∞C</span>
                    </div>
                    <div>
                      <span class="chip">üí® Viento m√°x ${d.wind_max_kmh} km/h</span>
                      <span class="chip">üå¨Ô∏è Rachas ${d.wind_gusts_max_kmh} km/h</span>
                    </div>
                    <div>
                      <span class="chip">üåÖ ${hhmm(d.sunrise)}</span>
                      <span class="chip">üåá ${hhmm(d.sunset)}</span>
                      <span class="chip">üè¢ ${d.operating_hours}</span>
                    </div>
                    <div>
                      <span class="chip" style="border-color:var(--ok)">üïê Ventana sugerida: ${d.suggested_window}</span>
                    </div>
                  </div>
                </div>
                <div class="day-half">
                  <div class="day-head">${next.label} ¬∑ ${next.date}</div>
                  <div class="day-body">
                    <div>
                      <span class="chip">${next.description}</span>
                      <span class="chip">üå°Ô∏è ${next.temp_min}¬∞C / ${next.temp_max}¬∞C</span>
                    </div>
                    <div>
                      <span class="chip">üí® Viento m√°x ${next.wind_max_kmh} km/h</span>
                      <span class="chip">üå¨Ô∏è Rachas ${next.wind_gusts_max_kmh} km/h</span>
                    </div>
                    <div>
                      <span class="chip">üåÖ ${hhmm(next.sunrise)}</span>
                      <span class="chip">üåá ${hhmm(next.sunset)}</span>
                      <span class="chip">üè¢ ${next.operating_hours}</span>
                    </div>
                    <div>
                      <span class="chip" style="border-color:var(--ok)">üïê Ventana sugerida: ${next.suggested_window}</span>
                    </div>
                  </div>
                </div>
              </div>
            </article>
          `);
          i += 2; // Saltar ambos d√≠as
        } else {
          // Renderizado normal para d√≠as con mapas o d√≠as individuales
          result.push(`
            <article class="day">
              <div class="day-head">${d.label} ¬∑ ${d.date}</div>
              <div class="day-body">
                <div>
                  <span class="chip">${d.description}</span>
                  <span class="chip">üå°Ô∏è ${d.temp_min}¬∞C / ${d.temp_max}¬∞C</span>
                </div>
                <div>
                  <span class="chip">üí® Viento m√°x ${d.wind_max_kmh} km/h</span>
                  <span class="chip">üå¨Ô∏è Rachas ${d.wind_gusts_max_kmh} km/h</span>
                </div>
                <div>
                  <span class="chip">üåÖ ${hhmm(d.sunrise)}</span>
                  <span class="chip">üåá ${hhmm(d.sunset)}</span>
                  <span class="chip">üè¢ ${d.operating_hours}</span>
                </div>
                <div>
                  <span class="chip" style="border-color:var(--ok)">üïê Ventana sugerida: ${d.suggested_window}</span>
                </div>
                ${d.show_aemet_maps ? `
                  <div>
                    <span class="chip">UTC disponibles: ${(d.available_utc_hours || []).join(" ¬∑ ") || "sin publicaci√≥n"}</span>
                  </div>
                  <div class="map-pair">
                    ${(d.map_slots || []).length
                      ? d.map_slots.map(slot => `
                          <div class="map-slot">
                            <div class="label">${slot.slot_label || (slot.utc_hour + " UTC")}</div>
                            ${mapImg(slot.map_b64, slot.map_url, `${d.label} ${slot.utc_hour} UTC`)}
                          </div>
                        `).join("")
                      : `<div class="map-slot"><div class="label">Sin mapas publicados para este d√≠a</div></div>`}
                  </div>
                ` : ""}
              </div>
            </article>
          `);
          i++;
        }
      }
      
      document.getElementById("days").innerHTML = result.join("");
    };

    const renderWindy = (windy) => {
      const selectedModel = windy.model || "gfs";
      state.windyModel = selectedModel;
      document.getElementById("windy-meta").textContent =
        `${windy.provider || "Windy"} ¬∑ modelo ${windy.model || "N/A"}`;

      const windyModelSelect = document.getElementById("windy-model");
      const availableModels = windy.available_models || ["gfs", "iconEu", "arome"];
      windyModelSelect.innerHTML = availableModels
        .map(m => `<option value="${m}" ${m === selectedModel ? "selected" : ""}>${m}</option>`)
        .join("");

      const windyError = document.getElementById("windy-error");
      if (windy.error) {
        windyError.style.display = "";
        windyError.textContent = `‚ö†Ô∏è ${windy.error}. Revisa que la key sea de tipo Point Forecast en api.windy.com/keys.`;
      } else {
        windyError.style.display = "none";
        windyError.textContent = "";
      }

      const windyMap = document.getElementById("windy-map");
      if (windy.map_embed_url) windyMap.src = windy.map_embed_url;

      const windyMapLink = document.getElementById("windy-map-link");
      windyMapLink.href = windy.map_link || "https://www.windy.com";
    };

    const render = (data) => {
      if (!data || !data.location || !data.current) return;

      document.getElementById("meta-line").textContent =
        `${data.location.name} ¬∑ ${data.location.icao} ¬∑ ${data.location.municipality}`;
      document.getElementById("refresh-line").textContent =
        `√öltima generaci√≥n: ${fmtDateTime(data.generated_at)}`;

      renderKv("aerodrome-kv", [
        ["Coordenadas", data.location.coordinates],
        ["Frecuencia", `${data.location.radio} MHz`],
        ["Elevaci√≥n", data.location.elevation],
        ["Pista", data.location.runway],
        ["Invierno", data.location.hours_invierno],
        ["Verano", data.location.hours_verano],
      ]);

      renderKv("current-kv", [
        ["Hora dato", fmtDateTime(data.current.time)],
        ["Condici√≥n", data.current.condition],
        ["Temperatura", `${data.current.temperature}¬∞C (sens. ${data.current.feels_like}¬∞C)`],
        ["Humedad", `${data.current.humidity}%`],
        ["Viento", `${data.current.wind_speed_kmh} km/h desde ${data.current.wind_direction}¬∞`],
        ["Rachas", `${data.current.wind_gusts_kmh} km/h`],
        ["Nubosidad", `${data.current.cloud_cover}%`],
        ["Presi√≥n", `${data.current.pressure} hPa`],
      ]);

      // METAR LEAS (oficial)
      const metarLeas = data.metar?.leas?.raw || data.metar?.raw || "METAR LEAS no disponible en este ciclo.";
      document.getElementById("metar-leas-raw").textContent = metarLeas;
      
      // Clasificaci√≥n de vuelo LEAS
      const leasCategory = data.metar?.leas?.flight_category;
      if (leasCategory) {
        document.getElementById("metar-leas-category").innerHTML = `${leasCategory.emoji} <span style="color:${leasCategory.color}">${leasCategory.category}</span> - ${leasCategory.description}`;
      } else {
        document.getElementById("metar-leas-category").textContent = "";
      }

      // METAR LEMR (sint√©tico)
      if (data.metar?.lemr) {
        document.getElementById("metar-lemr-raw").textContent = data.metar.lemr.raw || "METAR LEMR no generado";
        document.getElementById("metar-lemr-disclaimer").textContent = data.metar.lemr.disclaimer || "";
        
        // Clasificaci√≥n de vuelo LEMR
        const lemrCategory = data.metar.lemr.flight_category;
        if (lemrCategory) {
          document.getElementById("metar-lemr-category").innerHTML = `${lemrCategory.emoji} <span style="color:${lemrCategory.color}">${lemrCategory.category}</span> - ${lemrCategory.description}`;
        } else {
          document.getElementById("metar-lemr-category").textContent = "";
        }
      } else {
        document.getElementById("metar-lemr-raw").textContent = "METAR LEMR no disponible";
        document.getElementById("metar-lemr-disclaimer").textContent = "";
        document.getElementById("metar-lemr-category").textContent = "";
      }

      // Mapa de an√°lisis
      const analysisImg = document.getElementById("analysis-map-img");
      const analysisUnavailable = document.getElementById("analysis-map-unavailable");
      if (data.analysis_map_url) {
        analysisImg.style.display = "";
        analysisUnavailable.style.display = "none";
        analysisImg.classList.remove("rotated");
        analysisImg.onload = () => {
          if (analysisImg.naturalHeight > analysisImg.naturalWidth) {
            analysisImg.classList.add("rotated");
          }
        };
        analysisImg.src = data.analysis_map_url;
      } else {
        analysisImg.style.display = "none";
        analysisUnavailable.style.display = "";
      }

      // Predicciones AEMET textuales
      const pred = data.aemet_prediccion || {};
      
      // Actualizar contenido de predicciones
      document.getElementById("pred-ast-hoy").textContent = pred.asturias_hoy || "No disponible";
      document.getElementById("pred-ast-man").textContent = pred.asturias_manana || "No disponible";
      document.getElementById("pred-ast-pas").textContent = pred.asturias_pasado_manana || "No disponible";
      document.getElementById("pred-llanera-0").textContent = pred.llanera_dia0 || "No disponible";
      document.getElementById("pred-llanera-1").textContent = pred.llanera_dia1 || "No disponible";
      document.getElementById("pred-llanera-2").textContent = pred.llanera_dia2 || "No disponible";
      document.getElementById("pred-llanera-3").textContent = pred.llanera_dia3 || "No disponible";
      
      // Actualizar iconos din√°micos en los t√≠tulos
      if (pred.asturias_hoy_icon) {
        document.getElementById("pred-ast-hoy-title").textContent = `${pred.asturias_hoy_icon} Predicci√≥n AEMET ‚Äî Asturias hoy`;
      }
      if (pred.asturias_manana_icon) {
        document.getElementById("pred-ast-man-title").textContent = `${pred.asturias_manana_icon} Predicci√≥n AEMET ‚Äî Asturias ma√±ana`;
      }
      if (pred.asturias_pasado_manana_icon) {
        document.getElementById("pred-ast-pas-title").textContent = `${pred.asturias_pasado_manana_icon} Predicci√≥n AEMET ‚Äî Asturias pasado ma√±ana`;
      }
      if (pred.llanera_dia0_icon) {
        document.getElementById("pred-llanera-0-title").textContent = `${pred.llanera_dia0_icon} Predicci√≥n AEMET ‚Äî Llanera (La Morgal) hoy`;
      }
      if (pred.llanera_dia1_icon) {
        document.getElementById("pred-llanera-1-title").textContent = `${pred.llanera_dia1_icon} Predicci√≥n AEMET ‚Äî Llanera (La Morgal) ma√±ana`;
      }
      if (pred.llanera_dia2_icon) {
        document.getElementById("pred-llanera-2-title").textContent = `${pred.llanera_dia2_icon} Predicci√≥n AEMET ‚Äî Llanera (La Morgal) pasado ma√±ana`;
      }
      if (pred.llanera_dia3_icon) {
        document.getElementById("pred-llanera-3-title").textContent = `${pred.llanera_dia3_icon} Predicci√≥n AEMET ‚Äî Llanera (La Morgal) 3¬∫ d√≠a`;
      }

      // IA - Convertir markdown a HTML
      const aiAnalysis = data.ai.expert_final_verdict || "Sin veredicto final.";
      const aiElement = document.getElementById("expert-final");
      // Usar marked.js para convertir markdown a HTML si est√° disponible
      if (typeof marked !== 'undefined') {
        try {
          aiElement.innerHTML = marked.parse(aiAnalysis);
        } catch (e) {
          console.warn('Error al parsear markdown:', e);
          // Fallback: formatear manualmente si falla marked
          aiElement.innerHTML = aiAnalysis
            .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
            .replace(/\n\n/g, '</p><p>')
            .replace(/^(.+)$/gm, '<p>$1</p>');
        }
      } else {
        // Fallback b√°sico si marked.js no est√° disponible
        aiElement.innerHTML = aiAnalysis
          .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
          .replace(/\n/g, '<br>');
      }

      // Windy
      const windy = data.windy || {};
      renderWindy(windy);

      const windyDaily = windy.daily_summary || [];
      const windyDailyTable = document.getElementById("windy-daily");
      if (windyDailyTable) {
        windyDailyTable.innerHTML = windyDaily.length
          ? windyDaily.map(d => `
              <tr>
                <td>${d.date || "N/A"}</td>
                <td>${d.max_wind_kmh ?? "N/A"}</td>
                <td>${d.max_gust_kmh ?? "N/A"}</td>
                <td>${d.avg_temp_c ?? "N/A"}</td>
                <td>${d.precip_total_mm ?? "N/A"}</td>
              </tr>
            `).join("")
          : `<tr><td colspan="5" class="muted">Sin datos Windy en este ciclo</td></tr>`;
      }

      const windyHourly = windy.hourly || [];
      const windyHourlyTable = document.getElementById("windy-hourly");
      if (windyHourlyTable) {
        windyHourlyTable.innerHTML = windyHourly.length
          ? windyHourly.map(h => `
              <tr>
                <td>${fmtDateTime(h.time_local)}</td>
                <td>${h.wind_kmh ?? "N/A"} km/h ¬∑ ${h.wind_dir_deg ?? "N/A"}¬∞</td>
                <td>${h.gust_kmh ?? "N/A"} km/h</td>
                <td>${h.temp_c ?? "N/A"} ¬∞C</td>
                <td>${h.cloud_cover_pct ?? "N/A"}%</td>
                <td>${h.precip_3h_mm ?? "N/A"} mm</td>
              </tr>
            `).join("")
          : `<tr><td colspan="6" class="muted">Sin datos horarios Windy en este ciclo</td></tr>`;
      }

      renderDays(data.forecast_days || []);
      setLoadStatus("");
    };

    const fetchReport = async () => {
      const model = state.windyModel || (state.data?.windy?.model) || "gfs";
      const url = `/api/report?windy_model=${encodeURIComponent(model)}`;
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) return null;
      return await r.json();
    };

    const fetchWindyOnly = async (model) => {
      const url = `/api/windy?windy_model=${encodeURIComponent(model || "gfs")}`;
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) return null;
      return await r.json();
    };

    const refreshData = async () => {
      try {
        const d = await fetchReport();
        if (!d) return;
        if (!state.data || d.cycle_id !== state.data.cycle_id || d.generated_at !== state.data.generated_at) {
          state.data = d;
          render(state.data);
        }
      } catch {}
    };

    document.getElementById("windy-model").addEventListener("change", async (e) => {
      state.windyModel = e.target.value || "gfs";
      document.getElementById("windy-meta").textContent = `Windy Point Forecast ¬∑ actualizando modelo ${state.windyModel}...`;
      const d = await fetchWindyOnly(state.windyModel);
      if (!d) return;
      const windy = d.windy || {};
      if (state.data) {
        state.data.windy = windy;
      }
      renderWindy(windy);
    });

    const bootstrap = async () => {
      try {
        setLoadStatus("‚è≥ Cargando datos meteorol√≥gicos...");
        const d = await fetchReport();
        if (!d) {
          setLoadStatus("‚ö†Ô∏è No se pudieron cargar los datos. Reintenta en unos segundos.", true);
          return;
        }
        state.data = d;
        render(state.data);
        
        // Cargar datos de Ogimet de forma diferida (no bloquea la carga inicial)
        setTimeout(() => loadOgimetWeek(), 100);
      } catch {
        setLoadStatus("‚ö†Ô∏è Error al cargar datos iniciales.", true);
      }
    };

    // ========================================================================
    // FUNCIONES OGIMET
    // ========================================================================

    async function loadOgimetWeek() {
      const container = document.getElementById('ogimet-week-container');
      const runInfoEl = document.getElementById('ogimet-run-info');
      
      try {
        const response = await fetch('/api/ogimet/week');
        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Error desconocido');
        }

        // Mostrar informaci√≥n del run
        if (runInfoEl) {
          runInfoEl.innerHTML = `üì° <strong>${data.run_info.full_label}</strong> ¬∑ ${data.total_days} d√≠as disponibles`;
          runInfoEl.style.display = 'block';
        }

        // Renderizar mapas
        container.className = 'ogimet-week-grid';
        container.innerHTML = data.week.map(day => `
          <div class="ogimet-day-card" onclick="openOgimetModal('${day.image_url}', '${day.description}')">
            <div class="ogimet-day-header">
              <div class="ogimet-day-label">${day.day_label}</div>
              <div class="ogimet-day-date">${day.date_formatted}</div>
            </div>
            <img src="${day.image_url}" 
                 alt="Mapa Ogimet ${day.day_label}" 
                 class="ogimet-map-preview"
                 loading="lazy"
                 onerror="if(!this.dataset.failed){this.dataset.failed='1';this.style.display='none';const err=document.createElement('div');err.className='ogimet-info';err.style.color='var(--warn)';err.textContent='‚ö†Ô∏è Imagen no disponible';this.parentElement.appendChild(err);}">
            <div class="ogimet-info">
              ${day.valid_time} UTC
            </div>
          </div>
        `).join('');

      } catch (error) {
        console.error('Error al cargar Ogimet:', error);
        container.className = '';
        container.innerHTML = `
          <div class="ogimet-error">
            ‚ùå Error al cargar previsi√≥n semanal: ${error.message}
          </div>
        `;
      }
    }

    function openOgimetModal(imageUrl, description) {
      const modal = document.getElementById('ogimetModal');
      const modalImg = document.getElementById('ogimetModalImg');
      const modalInfo = document.getElementById('ogimetModalInfo');
      
      modal.classList.add('show');
      modalImg.src = imageUrl;
      modalInfo.textContent = description;
      
      // Cerrar con ESC
      document.addEventListener('keydown', function escHandler(e) {
        if (e.key === 'Escape') {
          closeOgimetModal();
          document.removeEventListener('keydown', escHandler);
        }
      });
    }

    function closeOgimetModal() {
      const modal = document.getElementById('ogimetModal');
      modal.classList.remove('show');
    }

    // Cerrar modal al hacer click fuera de la imagen
    document.addEventListener('DOMContentLoaded', () => {
      const modal = document.getElementById('ogimetModal');
      if (modal) {
        modal.addEventListener('click', function(e) {
          if (e.target === modal) {
            closeOgimetModal();
          }
        });
      }
    });

    // ========================================================================

    bootstrap();
    setInterval(refreshData, 60 * 1000);
  </script>
</body>
</html>
